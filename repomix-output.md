This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-12-28 17:35:10

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
.gitignore
core
  templates
    core
      base_public.html
      base_users.html
      homepage.html
      messages.html
  urls.py
  views.py
GreenSquareCapital
  asgi.py
  tests
    live_tests
      test_live_auth_and_search.py
      test_live_listing_activation.py
      test_live_listing_and_estimate.py
      test_live_models.py
      test_live_search_and_opportunities.py
      test_live_smoke.py
      test_live_stripe_webhook.py
      __init__.py
    __init__.py
  urls.py
  wsgi.py
  __init__.py
investments
  admin.py
  apps.py
  forms.py
  migrations
    0001_initial.py
    __init__.py
  models.py
  services.py
  tests.py
  urls.py
  views.py
  __init__.py
listings
  admin.py
  apps.py
  forms.py
  migrations
    0001_initial.py
    __init__.py
  models.py
  services
    payments.py
    pricing.py
  templates
    listings
      create_listing.html
      edit_listing.html
      opportunity_detail.html
      search_listings.html
  tests.py
  urls.py
  __init__.py
manage.py
pytest.ini
requirements-test.txt
search
  admin.py
  apps.py
  migrations
    __init__.py
  models.py
  tests.py
  urls.py
  views.py
  __init__.py
static
  admin.py
  apps.py
  assets
    stylesheets
      authentication.css
      base.css
      components.css
      dashboard.css
      homepage.css
  js
    click_hold_drag_scroll.js
    listing_stepper.js
    login_register_toggle.js
    pledge_progress.js
    search_filters.js
  migrations
    __init__.py
  models.py
  tests.py
  views.py
  __init__.py
users
  admin.py
  apps.py
  backends.py
  migrations
    __init__.py
  models.py
  services.py
  templates
    users
      dashboard.html
  tests.py
  urls.py
  __init__.py
```

# Repository Files


## .gitignore

```text
# Python
__pycache__/
*.py[cod]
*$py.class

# Virtual environments
.venv/
venv/

# Environment / secrets
.env
env.py

# Database
db.sqlite3
*.sqlite3

# Media uploads
media/

# Collected static files
staticfiles/

# OS
.DS_Store
Thumbs.db
.vscode/
.idea/
```

## core/templates/core/base_public.html

```html
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Page title using Django block -->
  <title>{% block title %}Green Square Capital{% endblock %}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons (required for message icons) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'assets/stylesheets/base.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/authentication.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/homepage.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/components.css' %}">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/favicon/apple-touch-icon.png' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'assets/favicon/favicon-32x32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'assets/favicon/favicon-16x16.png' %}">
</head>

<body class="d-flex flex-column min-vh-100 bg-white">

  {# --- Public Navbar --- #}
  <nav class="gsc-bar gsc-nav sticky-top">
    <div class="container-xxl gsc-bar-inner">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-3 py-3">

        <div class="d-flex align-items-center gap-3">
          <span class="badge gsc-brand-badge">GSC</span>

          <div class="min-w-0">
            <div class="gsc-brand-title">
              {% if request.path != '/' %}
              <a href="{% url 'core:homepage' %}" class="gsc-nav-link fw-semibold" title="Go to Homepage">
                Green Square Capital
              </a>
              {% else %}
              <span class="fw-semibold">Green Square Capital</span>
              {% endif %}
            </div>
            <div class="gsc-brand-subtitle d-none d-md-block">
              Where investment meets opportunity
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'users:login' %}" class="gsc-nav-chip">Sign In</a>
          <a href="{% url 'users:register' %}" class="gsc-nav-chip">Create Account</a>
        </div>

      </div>
    </div>
  </nav>

  {# --- Flash messages --- #}
  {% if messages %}
  <div class="container-xxl mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show gsc-alert">
      <div class="d-flex gap-2 align-items-start">
        <i class="bi bi-info-circle mt-1"></i>
        <div class="flex-grow-1">{{ message }}</div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <main class="flex-grow-1">
    {% block content %}{% endblock %}
  </main>

  {# --- Footer (matching navbar) --- #}
  <footer class="gsc-bar gsc-footer mt-auto">
    <div class="container-xxl gsc-bar-inner">
      <div class="py-4">

        <div class="row gy-3 small text-center text-md-start align-items-start">
          <div class="col-12 col-md-4">
            <div class="fw-semibold mb-1">Company</div>
            <div>Reg Company Number — 474758</div>
            <div>Reg Address — 99 Market Street</div>
          </div>

          <div class="col-12 col-md-4 text-md-center">
            <div class="fw-semibold mb-1">Policies</div>
            <div><a href="#" class="gsc-footer-link">Privacy Policy</a></div>
            <div><a href="#" class="gsc-footer-link">Terms &amp; Conditions</a></div>
          </div>

          <div class="col-12 col-md-4 text-md-end">
            <div class="fw-semibold mb-1">Support</div>
            <div>0333 777 888</div>
            <div><a href="mailto:support@gsc.com" class="gsc-footer-link">support@gsc.com</a></div>
          </div>
        </div>

        <div class="gsc-footer-bottom">
          <div>© {% now "Y" %} Green Square Capital</div>
          <div>Built by JSGREEN1129</div>
        </div>

      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  {% block extra_js %}{% endblock %}

</body>

</html>
```

## core/templates/core/base_users.html

```html
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Green Square Capital{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'assets/stylesheets/base.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/authentication.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/homepage.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'assets/stylesheets/components.css' %}">


  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/favicon/apple-touch-icon.png' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'assets/favicon/favicon-32x32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'assets/favicon/favicon-16x16.png' %}">
</head>

<body class="d-flex flex-column min-vh-100 bg-white">

  {# --- User Navbar --- #}
  <nav class="gsc-bar gsc-nav sticky-top">
    <div class="container-xxl gsc-bar-inner">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-3 py-3">

        <div class="d-flex align-items-center gap-3">
          <span class="badge gsc-brand-badge">GSC</span>

          <div class="min-w-0">
            <div class="gsc-brand-title">
              {% if request.path != '/users/dashboard/' %}
              <a href="{% url 'users:dashboard' %}" class="gsc-nav-link fw-semibold">
                Green Square Capital
              </a>
              {% else %}
              <span class="fw-semibold">Green Square Capital</span>
              {% endif %}
            </div>
            <div class="gsc-brand-subtitle d-none d-md-block">
              Investor dashboard
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">

          <span class="text-white small d-none d-md-inline ms-2">
            {{ user.first_name|default:user.email }}
          </span>

          <a href="{% url 'listings:search_listings' %}" class="gsc-nav-chip">
            <i class="bi bi-search me-1"></i>
            Search opportunities
          </a>

          <a href="{% url 'users:logout' %}" class="gsc-nav-chip">
            Logout
          </a>

        </div>

      </div>
    </div>
  </nav>

  {# --- Flash messages --- #}
  {% if messages %}
  <div class="container-xxl mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show gsc-alert">
      <div class="d-flex gap-2 align-items-start">
        <i class="bi bi-info-circle mt-1"></i>
        <div class="flex-grow-1">{{ message }}</div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <main class="flex-grow-1">
    {% block content %}{% endblock %}
  </main>

  {# --- Footer (matches public) --- #}
  <footer class="gsc-bar gsc-footer mt-auto">
    <div class="container-xxl gsc-bar-inner">
      <div class="py-4">

        <div class="row gy-3 small text-center text-md-start align-items-start">
          <div class="col-12 col-md-4">
            <div class="fw-semibold mb-1">Company</div>
            <div>Reg Company Number — 474758</div>
            <div>Reg Address — 99 Market Street</div>
          </div>

          <div class="col-12 col-md-4 text-md-center">
            <div class="fw-semibold mb-1">Policies</div>
            <div><a href="#" class="gsc-footer-link">Privacy Policy</a></div>
            <div><a href="#" class="gsc-footer-link">Terms &amp; Conditions</a></div>
          </div>

          <div class="col-12 col-md-4 text-md-end">
            <div class="fw-semibold mb-1">Support</div>
            <div>0333 777 888</div>
            <div><a href="mailto:support@gsc.com" class="gsc-footer-link">support@gsc.com</a></div>
          </div>
        </div>

        <div class="gsc-footer-bottom">
          <div>© {% now "Y" %} Green Square Capital</div>
          <div>Built by JSGREEN1129</div>
        </div>

      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  {% block extra_js %}{% endblock %}
</body>

</html>
```

## core/templates/core/homepage.html

```html
{% extends "core/base_public.html" %}
{% load static %}

{% block title %}GSC - Green Square Capital{% endblock %}

{% block content %}

<!-- HERO -->
<section class="gsc-hero position-relative overflow-hidden">
  <div class="container py-5 py-lg-6 position-relative">
    <div class="row align-items-center g-4">
      <div class="col-12 col-lg-7 text-white">

        <h1 class="display-5 fw-semibold lh-sm mb-3">
          Where Real Estate Investors Meet Real Estate Investment Opportunities
        </h1>

        <p class="lead text-white mb-4">
          Browse vetted opportunities, pledge with confidence, and track expected returns, all in one
          secure and transparent platform.
        </p>

        <div class="d-flex flex-wrap gap-2">
          <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
            Explore opportunities
          </a>
          <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
            List a project
          </a>
        </div>

        <div class="d-flex flex-wrap gap-3 mt-4 text-white-50 small">
          <div><span class="fw-semibold text-white">Transparent</span> pricing &amp; terms</div>
          <div><span class="fw-semibold text-white">Fast</span> pledging experience</div>
          <div><span class="fw-semibold text-white">Secure</span> platform flows</div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <!-- “Glass” info panels -->
        <div class="row g-3">
          <div class="col-12">
            <div class="card gsc-glass border-0 shadow-sm">
              <div class="card-body p-4">
                <h2 class="h5 mb-2 text-white">For Investors</h2>
                <p class="mb-0 text-white">
                  Find projects listed by developers, pledge amounts that suit you, and earn returns based
                  on each listing’s return band.
                </p>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card gsc-glass border-0 shadow-sm">
              <div class="card-body p-4">
                <h2 class="h5 mb-2 text-white">For Developers</h2>
                <p class="mb-0 text-white">
                  List your opportunity, attract investors, and secure funding while offering clear,
                  transparent returns.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="gsc-hero-divider" aria-hidden="true"></div>
</section>

<!-- STATS STRIP -->
<section class="gsc-stats-strip py-4 py-lg-5">
  <div class="container">
    <div class="row g-3 text-center">

      <div class="col-6 col-lg-3">
        <div class="gsc-stat">
          <div class="h3 mb-0 text-white fw-semibold">Fast</div>
          <div class="small text-white">Pledge flow</div>
        </div>
      </div>

      <div class="col-6 col-lg-3">
        <div class="gsc-stat">
          <div class="h3 mb-0 text-white fw-semibold">Clear</div>
          <div class="small text-white">Return bands</div>
        </div>
      </div>

      <div class="col-6 col-lg-3">
        <div class="gsc-stat">
          <div class="h3 mb-0 text-white fw-semibold">Secure</div>
          <div class="small text-white">Platform processes</div>
        </div>
      </div>

      <div class="col-6 col-lg-3">
        <div class="gsc-stat">
          <div class="h3 mb-0 text-white fw-semibold">UK</div>
          <div class="small text-white">Location-led search</div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- HOW IT WORKS -->
<section class="py-5 py-lg-6 bg-body-tertiary">
  <div class="container">

    <div class="text-center mb-4 mb-lg-5">
      <h2 class="h2 mt-3 text-success mb-2">Invest in 3 simple steps</h2>
      <p class="text-muted mb-0">A streamlined process designed for clarity and confidence.</p>
    </div>

    <div class="row g-4">
      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <div class="gsc-icon-bubble mb-3">1</div>
            <h3 class="h5 fw-semibold text-success mb-2">Browse opportunities</h3>
            <p class="text-muted mb-0">
              Filter by location, funding band, and return profile to find opportunities that match your strategy.
            </p>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <div class="gsc-icon-bubble mb-3">2</div>
            <h3 class="h5 fw-semibold text-success mb-2">Pledge in minutes</h3>
            <p class="text-muted mb-0">
              Choose an amount, view expected return ranges, and pledge directly from the listing.
            </p>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <div class="gsc-icon-bubble mb-3">3</div>
            <h3 class="h5 fw-semibold text-success mb-2">Track &amp; manage</h3>
            <p class="text-muted mb-0">
              Monitor pledges and listing progress from your dashboard with a clean, transparent view.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4 mt-lg-5">
      <a href="{% url 'users:register' %}" class="btn btn-outline-success btn-lg">
        Browse live opportunities
      </a>
    </div>

  </div>
</section>

<!-- FEATURED OPPORTUNITIES -->
<section class="py-5 py-lg-6 bg-white">
  <div class="container">

    <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-4">
      <div>
        <span class="badge bg-success text-white border rounded-pill px-3 py-2">Featured</span>
        <h2 class="h3 mt-3 text-success mb-1">Opportunities live right now</h2>
        <p class="text-muted mb-0">A quick snapshot — create an account to view full details and pledge.</p>
      </div>
      <a href="{% url 'users:register' %}" class="btn btn-outline-success btn-lg">
        View all opportunities
      </a>
    </div>

    {% if featured_listings %}
      {# px-2 adds side breathing room on mobile; removed from md+ #}
      <div class="row g-4 mt-3 px-2 px-md-0">
        {% for listing in featured_listings %}
          <div class="col-12 col-md-4">
            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl h-100">
              <div class="card-body p-4 d-flex flex-column">

                <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                  <div class="min-w-0">
                    <h3 class="h5 fw-semibold text-success mb-1 text-truncate">
                      {{ listing.source_use|capfirst }} → {{ listing.target_use|capfirst }}
                    </h3>
                    <p class="text-muted small mb-0 text-truncate">
                      {{ listing.country|capfirst }} • {{ listing.county }} • {{ listing.postcode_prefix }}
                    </p>
                  </div>
                  <span class="badge text-bg-success rounded-pill px-3">Active</span>
                </div>

                <div class="rounded-4 bg-light p-3 my-3">
                  <div class="d-flex justify-content-between small">
                    <span class="text-muted">Funding</span>
                    <span class="fw-semibold">{{ listing.get_funding_band_display }}</span>
                  </div>
                  <div class="d-flex justify-content-between small mt-2">
                    <span class="text-muted">Return Type</span>
                    <span class="fw-semibold">{{ listing.get_return_type_display }}</span>
                  </div>
                  <div class="d-flex justify-content-between small mt-2">
                    <span class="text-muted">Potential Return</span>
                    <span class="fw-semibold">{{ listing.get_return_band_display }}</span>
                  </div>
                </div>

                {# Public users go to register #}
                <a href="{% url 'users:register' %}" class="btn btn-sm btn-outline-success rounded-pill px-3 mt-auto">
                  View listing
                </a>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card border-success shadow-sm rounded-xxl">
        <div class="card-body p-4 p-md-5">
          <h3 class="h5 fw-semibold text-success mb-1">New opportunities added regularly</h3>
          <p class="text-muted mb-0">
            Create an account to browse live opportunities and pledge.
          </p>
          <div class="mt-3">
            <a href="{% url 'users:register' %}" class="btn btn-outline-success btn-white">
              Create an account
            </a>
          </div>
        </div>
      </div>
    {% endif %}

  </div>
</section>

<!-- WHY GSC -->
<section class="py-5 py-lg-6 bg-body-tertiary">
  <div class="container">

    <div class="text-center mb-4 mb-lg-5">
      <h2 class="h2 mt-3 text-success mb-2">Built for clarity and confidence</h2>
      <p class="text-muted mb-0">A platform experience that keeps investing straightforward.</p>
    </div>

    <div class="row g-4">
      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <h3 class="h5 fw-semibold text-success mb-2">Clear return bands</h3>
            <p class="text-muted mb-0">Understand potential outcomes quickly with consistent return profiles.</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <h3 class="h5 fw-semibold text-success mb-2">Location-led search</h3>
            <p class="text-muted mb-0">Find opportunities by country, county, and postcode prefix—fast.</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="homepage-card border-success shadow-sm rounded-xxl h-100">
          <div class="card-body p-4">
            <h3 class="h5 fw-semibold text-success mb-2">Simple pledge flow</h3>
            <p class="text-muted mb-0">Pledge directly from results with an experience that stays friction-free.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CTA band inside section -->
    <div class="gsc-cta-band mt-4 mt-lg-5">
      <div class="row align-items-center g-3">
        <div class="col-12 col-lg-8">
          <h3 class="h4 mb-1 text-white">Ready to explore live opportunities?</h3>
          <p class="mb-0 text-white">Create an account to search by location, view details, and pledge.</p>
        </div>
        <div class="col-12 col-lg-4 d-grid d-lg-flex justify-content-lg-end gap-3">
          <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
            Explore opportunities
          </a>
          <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
            List a project
          </a>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- SUCCESSFUL PROJECTS -->
<section class="py-5 py-lg-6 bg-white">
  <div class="container">

    <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-4">
      <div>
        <h2 class="h2 text-success mb-1">Successful Projects</h2>
        <p class="text-muted mb-0">Examples of completed projects funded through Green Square Capital</p>
      </div>
      <a href="{% url 'users:register' %}" class="btn btn-outline-success btn-lg">
        View live opportunities
      </a>
    </div>

    <div class="row g-4">

      <!-- Project 1 -->
      <div class="col-12 col-md-6">
        <article class="card gsc-project-card border-0 shadow-sm h-100"
          style="--bg-image: url('{% static 'images/homepage_completed_project_1.png' %}');">
          <div class="card-body p-4 d-flex flex-column">
            <div class="mb-3">
              <span class="badge text-bg-success bg-opacity-75 rounded-pill">Completed</span>
            </div>

            <h3 class="h5 fw-semibold mb-2">
              Old Cotton Factory Works, Manchester
            </h3>

            <p class="mb-0">
              A former commercial building transformed into four modern, refurbished residential flats —
              turning underutilised space into high-quality rental accommodation.
            </p>

            <div class="mt-auto pt-3">
              <span class="text-white small">117 Green Street • Manchester</span>
            </div>
          </div>
        </article>
      </div>

      <!-- Project 2 -->
      <div class="col-12 col-md-6">
        <article class="card gsc-project-card border-0 shadow-sm h-100"
          style="--bg-image: url('{% static 'images/homepage_completed_project_2.png' %}');">
          <div class="card-body p-4 d-flex flex-column">
            <div class="mb-3">
              <span class="badge text-bg-success bg-opacity-75 rounded-pill">Completed</span>
            </div>

            <h3 class="h5 fw-semibold mb-2">
              Bedford Police Station, Bristol
            </h3>

            <p class="mb-0">
              A former police station converted into residential flats with an exclusive residents’ gym —
              improving value and long-term rental income.
            </p>

            <div class="mt-auto pt-3">
              <span class="text-white small">99b Walkaway • Bristol</span>
            </div>
          </div>
        </article>
      </div>

      <!-- Project 3 -->
      <div class="col-12 col-md-6">
        <article class="card gsc-project-card border-0 shadow-sm h-100"
          style="--bg-image: url('{% static 'images/homepage_completed_project_3.png' %}');">
          <div class="card-body p-4 d-flex flex-column">
            <div class="mb-3">
              <span class="badge text-bg-success bg-opacity-75 rounded-pill">Completed</span>
            </div>

            <h3 class="h5 fw-semibold mb-2">
              The Willow House, Leeds
            </h3>

            <p class="mb-0">
              A derelict property renovated into a comfortable family home — increasing market value and
              enabling stable rental potential.
            </p>

            <div class="mt-auto pt-3">
              <span class="text-white small">22 Meadow Lane • Leeds</span>
            </div>
          </div>
        </article>
      </div>

      <!-- Project 4 -->
      <div class="col-12 col-md-6">
        <article class="card gsc-project-card border-0 shadow-sm h-100"
          style="--bg-image: url('{% static 'images/homepage_completed_project_4.png' %}');">
          <div class="card-body p-4 d-flex flex-column">
            <div class="mb-3">
              <span class="badge text-bg-success bg-opacity-75 rounded-pill">Completed</span>
            </div>

            <h3 class="h5 fw-semibold mb-2">
              Hawthorne Manor, Oxford
            </h3>

            <p class="mb-0">
              A historic manor converted into modern serviced offices — preserving character while creating
              consistent commercial income.
            </p>

            <div class="mt-auto pt-3">
              <span class="text-white small">15 Kingsway • Oxford</span>
            </div>
          </div>
        </article>
      </div>

    </div>
  </div>
</section>

<!-- FINAL CTA -->
<section class="py-5 py-lg-6 bg-body-tertiary">
  <div class="container">
    <div class="homepage-card-final-cta border-success shadow-sm rounded-xxl overflow-hidden">
      <div class="card-body p-4 p-md-5">
        <div class="row align-items-center g-4">
          <div class="col-12 col-lg-8">
            <h2 class="h3 mt-3 text-white mb-2">Join Green Square Capital today</h2>
            <p class="text-white mb-0">
              Create your account to browse opportunities, pledge, and manage activity in your dashboard.
            </p>
          </div>
          <div class="col-12 col-lg-4 d-grid gap-2">
            <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
              Create an account
            </a>
            <a href="{% url 'users:register' %}" class="btn btn-outline-light btn-lg">
              Browse opportunities
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock %}
```

## core/templates/core/messages.html

```html
{% if messages %}
<div class="container-fluid mt-2 mb-3 px-0">

    {# Loop through messages, only displays the last looped messages #}
    {% for message in messages %}
    {% if forloop.last %}
    <div class="alert
        {# Determine the Bootstrap alert class based on message type or level #} 
        {% if message.tags %}alert-{{ message.tags }}
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}alert-danger
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}alert-success
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}alert-warning
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.INFO %}alert-info
        {% elif message.level == DEFAULT_MESSAGE_LEVELS.DEBUG %}alert-secondary
        {% else %}alert-primary
        {% endif %}
        alert-dismissible fade show" role="alert" id="main-message-alert">

        <div class="d-flex align-items-center">
            {# Use Bootstrap icons based on message type #}
            <i class="bi {% if message.tags == 'success' or message.level == 25 %}bi-check-circle-fill text-success
                {% elif message.tags == 'error' or message.level == 40 %}bi-exclamation-triangle-fill text-danger
                {% elif message.tags == 'warning' or message.level == 30 %}bi-exclamation-circle-fill text-warning
                {% else %}bi-info-circle-fill text-info
                {% endif %} me-2"></i>
            <div class="flex-grow-1">{{ message }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<style>
    /* Ensure smooth animations */
    #main-message-alert {
        animation: slideInDown 0.3s ease-out;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        border-radius: 0.375rem;
    }

    /* Custom animation for message appearance */
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

</style>

<script>
    // Auto-hide success messages after 5 seconds, keep errors visible longer
    document.addEventListener('DOMContentLoaded', function () {
        const alertElement = document.getElementById('main-message-alert');
        if (alertElement) {
            // Check if it's a success message
            const isSuccess = alertElement.classList.contains('alert-success');
            const isError = alertElement.classList.contains('alert-danger');

            let autoHideDelay = isSuccess ? 5000 : (isError ? 10000 : 7000);

            setTimeout(function () {
                const bsAlert = new bootstrap.Alert(alertElement);
                bsAlert.close();
            }, autoHideDelay);

            // Listen for close event to remove from storage
            alertElement.addEventListener('closed.bs.alert', function () {
            });
        }
    });

    // Prevent multiple messages from showing simultaneously
    function ensureSingleMessage() {
        const alerts = document.querySelectorAll('.alert');
        if (alerts.length > 1) {
            // Hide all but the last one
            alerts.forEach((alert, index) => {
                if (index < alerts.length - 1) {
                    alert.style.display = 'none';
                }
            });
        }
    }

    ensureSingleMessage();
</script>
{% endif %}
```

## core/urls.py

```python
from django.urls import path
from .views import home

app_name = "core"

urlpatterns = [
    path("", home, name="homepage"),
]
```

## core/views.py

```python
from django.shortcuts import render
from listings.models import Listing

def home(request):
    featured_listings = (
        Listing.objects
        .filter(status="active")
        .order_by("?")[:3]
    )

    return render(request, "core/homepage.html", {
        "featured_listings": featured_listings,
    })
```

## GreenSquareCapital/asgi.py

```python
"""
ASGI config for GreenSquareCapital project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'GreenSquareCapital.settings')

application = get_asgi_application()
```

## GreenSquareCapital/tests/live_tests/test_live_auth_and_search.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_login_and_dashboard(http, live_base_url, login, live_user_credentials):
    username, password = live_user_credentials
    login(username, password)
    dash = build_url(live_base_url, "users:dashboard")
    r = http.get(dash, timeout=30)
    assert r.status_code == 200


@pytest.mark.live
def test_search_listings(http, live_base_url):
    url = build_url(live_base_url, "listings:search_listings", query="q=")
    r = http.get(url, timeout=30)
    assert r.status_code == 200
```

## GreenSquareCapital/tests/live_tests/test_live_listing_activation.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_activate_requires_login(http, live_base_url, live_listing_id):
    url = build_url(live_base_url, "listings:activate_listing", args=[live_listing_id])
    r = http.get(url, timeout=30, allow_redirects=False)
    assert r.status_code in (301, 302, 303)
    assert "users/login" in r.headers.get("Location", "")


@pytest.mark.live
def test_activate_only_draft_listings(http, live_base_url, login, live_user_credentials, live_listing_id):
    username, password = live_user_credentials
    login(username, password)

    url = build_url(live_base_url, "listings:activate_listing", args=[live_listing_id])
    r = http.get(url, timeout=60, allow_redirects=True)  
    assert r.status_code == 200 or r.status_code == 302
    if "only draft listings can be activated" in r.text.lower():
        pass  
    else:
        assert "checkout" in r.text.lower()
```

## GreenSquareCapital/tests/live_tests/test_live_listing_and_estimate.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_estimate_return_json_when_authenticated(http, live_base_url, login, live_user_credentials, live_listing_id):
    username, password = live_user_credentials
    login(username, password)

    assert any(c.name == "sessionid" for c in http.cookies), (
        f"Expected sessionid cookie after login. Cookies={[c.name for c in http.cookies]}"
    )

    headers = {
        "Accept": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "Origin": live_base_url.rstrip("/"),
        "Referer": build_url(live_base_url, "listings:listing_detail", args=[live_listing_id]),
    }

    url = build_url(live_base_url, "listings:estimate_return", args=[live_listing_id])

    r = http.get(url, headers=headers, params={"amount": "100"}, timeout=30, allow_redirects=False)

    if r.status_code in (301, 302, 303, 307, 308):
        location = r.headers.get("Location", "")
        pytest.fail(f"estimate_return redirected unexpectedly to: {location}")

    assert r.status_code == 200

    content_type = (r.headers.get("Content-Type") or "").lower()
    assert "application/json" in content_type, (
        f"Expected JSON but got Content-Type={content_type}. "
        f"Final URL={r.url}. Body starts:\n{r.text[:300]}"
    )

    data = r.json()
    assert isinstance(data, dict)
    assert data.get("ok") is True
```

## GreenSquareCapital/tests/live_tests/test_live_models.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_listing_detail_loads(http, live_base_url, login, live_user_credentials, live_listing_id):
    username, password = live_user_credentials
    login(username, password)

    url = build_url(live_base_url, "listings:listing_detail", args=[live_listing_id])
    r = http.get(url, timeout=30, allow_redirects=True)  

    assert r.status_code == 200, f"Expected 200 OK, got {r.status_code}"


    assert "Listing" in r.text, "Page should have 'Listing' in title or content"
    assert "Green Square Capital" in r.text, "Footer/brand name missing"
    assert "pledge_progress" in r.text.lower(), "Pledge progress script missing (expected on detail page)"



@pytest.mark.live
def test_listing_media_str_in_page(http, live_base_url, login, live_user_credentials, live_listing_id):
    pytest.skip("Media str test requires media detail endpoint; check manually in listing detail")
```

## GreenSquareCapital/tests/live_tests/test_live_search_and_opportunities.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_search_requires_login(http, live_base_url):
    url = build_url(live_base_url, "listings:search_listings")
    r = http.get(url, timeout=30, allow_redirects=False)
    assert r.status_code in (301, 302, 303)
    assert "users/login" in r.headers.get("Location", "").lower()


@pytest.mark.live
def test_search_shows_active_listings(http, live_base_url, login, live_user_credentials):
    username, password = live_user_credentials
    login(username, password)

    url = build_url(live_base_url, "listings:search_listings")
    r = http.get(url, timeout=30, allow_redirects=True)
    assert r.status_code == 200

    assert "search listings" in r.text.lower()
    assert "green square capital" in r.text.lower()

    assert "counties" in r.text.lower() or "outcodes" in r.text.lower()  


@pytest.mark.live
def test_search_filters_by_project_name(http, live_base_url, login, live_user_credentials):
    username, password = live_user_credentials
    login(username, password)

    url = build_url(live_base_url, "listings:search_listings")  
    r = http.get(url, timeout=30, allow_redirects=True)
    assert r.status_code == 200

    assert "search listings" in r.text.lower()
    assert "green square capital" in r.text.lower()



@pytest.mark.live
def test_opportunity_detail_requires_login(http, live_base_url, live_listing_id):
    url = build_url(live_base_url, "listings:opportunity_detail", args=[live_listing_id])
    r = http.get(url, timeout=30, allow_redirects=False)
    assert r.status_code in (301, 302, 303)
    assert "users/login" in r.headers.get("Location", "").lower()


@pytest.mark.live
def test_opportunity_detail_only_for_active(http, live_base_url, login, live_user_credentials, live_listing_id):
    username, password = live_user_credentials
    login(username, password)

    url = build_url(live_base_url, "listings:opportunity_detail", args=[live_listing_id])
    r = http.get(url, timeout=30, allow_redirects=True)
    assert r.status_code == 200 or r.status_code == 404  
    assert "opportunity" in r.text.lower() or "pledge" in r.text.lower()
```

## GreenSquareCapital/tests/live_tests/test_live_smoke.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_homepage_loads(http, live_base_url):
    url = live_base_url.rstrip("/") + "/"
    r = http.get(url, timeout=30, allow_redirects=True)
    assert r.status_code == 200


@pytest.mark.live
def test_login_page_loads(http, live_base_url):
    url = build_url(live_base_url, "users:login")
    r = http.get(url, timeout=30)
    assert r.status_code == 200
```

## GreenSquareCapital/tests/live_tests/test_live_stripe_webhook.py

```python
import pytest

from .conftest import build_url


@pytest.mark.live
def test_stripe_webhook_rejects_bad_request(http, live_base_url):
    url = build_url(live_base_url, "listings:stripe_webhook")
    r = http.post(url, data=b"{}", headers={"Content-Type": "application/json"}, timeout=30)
    assert 400 <= r.status_code < 500


@pytest.mark.live
@pytest.mark.skip("Requires real Stripe config/sig — test manually or with ngrok")
def test_stripe_webhook_returns_200_on_valid(http, live_base_url):
    url = build_url(live_base_url, "listings:stripe_webhook")
    headers = {"Content-Type": "application/json", "Stripe-Signature": "fake_sig"}
    data = b'{"type": "checkout.session.completed", "data": {"object": {"payment_status": "paid"}}}'
    r = http.post(url, data=data, headers=headers, timeout=30)
    assert r.status_code == 200
```

## GreenSquareCapital/tests/live_tests/__init__.py

```python

```

## GreenSquareCapital/tests/__init__.py

```python

```

## GreenSquareCapital/urls.py

```python
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path("", include("core.urls")),
    path("admin/", admin.site.urls),
    path("users/", include("users.urls")),
    path("listings/", include("listings.urls")),
    path("investments/", include("investments.urls")),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

## GreenSquareCapital/wsgi.py

```python
"""
WSGI config for GreenSquareCapital project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'GreenSquareCapital.settings')

application = get_wsgi_application()
```

## GreenSquareCapital/__init__.py

```python

```

## investments/admin.py

```python
from django.contrib import admin

# Register your models here.
```

## investments/apps.py

```python
from django.apps import AppConfig


class InvestmentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'investments'
```

## investments/forms.py

```python
from decimal import Decimal
from django import forms


class InvestmentPledgeForm(forms.Form):
    amount_gbp = forms.DecimalField(min_value=Decimal("1.00"), max_digits=12, decimal_places=2)
```

## investments/migrations/0001_initial.py

```python
# Generated by Django 5.2.8 on 2025-12-21 21:23

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('listings', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Investment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('amount_pence', models.PositiveIntegerField()),
                ('expected_return_pence', models.PositiveIntegerField(default=0)),
                ('expected_total_back_pence', models.PositiveIntegerField(default=0)),
                ('status', models.CharField(choices=[('pledged', 'Pledged'), ('cancelled', 'Cancelled')], default='pledged', max_length=20)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('investor', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='investments', to=settings.AUTH_USER_MODEL)),
                ('listing', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='investments', to='listings.listing')),
            ],
            options={
                'indexes': [models.Index(fields=['listing', 'status'], name='investments_listing_cac3e9_idx'), models.Index(fields=['investor', 'status'], name='investments_investo_5c61c8_idx')],
            },
        ),
    ]
```

## investments/migrations/__init__.py

```python

```

## investments/models.py

```python
from decimal import Decimal, ROUND_HALF_UP

from django.conf import settings
from django.db import models
from django.utils import timezone


class Investment(models.Model):
    class Status(models.TextChoices):
        PLEDGED = "pledged", "Pledged"
        CANCELLED = "cancelled", "Cancelled"

    investor = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="investments",
    )
    listing = models.ForeignKey(
        "listings.Listing",
        on_delete=models.CASCADE,
        related_name="investments",
    )

    amount_pence = models.PositiveIntegerField()
    expected_return_pence = models.PositiveIntegerField(default=0)
    expected_total_back_pence = models.PositiveIntegerField(default=0)

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PLEDGED,
    )
    created_at = models.DateTimeField(default=timezone.now)

    class Meta:
        indexes = [
            models.Index(fields=["listing", "status"]),
            models.Index(fields=["investor", "status"]),
        ]

    @staticmethod
    def _pence_to_gbp(pence: int) -> Decimal:
        return (Decimal(pence) / Decimal("100")).quantize(
            Decimal("0.01"), rounding=ROUND_HALF_UP
        )

    @property
    def amount_gbp(self) -> Decimal:
        return self._pence_to_gbp(self.amount_pence)

    @property
    def expected_return_gbp(self) -> Decimal:
        return self._pence_to_gbp(self.expected_return_pence)

    @property
    def expected_total_back_gbp(self) -> Decimal:
        return self._pence_to_gbp(self.expected_total_back_pence)

    def __str__(self):
        return f"{self.investor_id} -> {self.listing_id} (£{self.amount_gbp})"
```

## investments/services.py

```python
from dataclasses import dataclass
from decimal import Decimal, ROUND_HALF_UP


@dataclass(frozen=True)
class ReturnResult:
    expected_return_pence: int
    expected_total_back_pence: int


def calculate_expected_return_pence(*, amount_pence: int, total_return_percent: Decimal) -> ReturnResult:
    """
    total_return_percent is the TOTAL return percent for the opportunity (NOT annualised, NOT pro-rated).
    Uses Decimal math and ROUND_HALF_UP to avoid float rounding issues.
    """
    if amount_pence <= 0:
        return ReturnResult(0, max(amount_pence, 0))

    if total_return_percent <= 0:
        return ReturnResult(0, amount_pence)

    expected_return = (Decimal(amount_pence) * (total_return_percent / Decimal("100"))).quantize(
        Decimal("1"), rounding=ROUND_HALF_UP
    )
    expected_return_pence = int(expected_return)
    return ReturnResult(expected_return_pence, amount_pence + expected_return_pence)
```

## investments/tests.py

```python
from django.test import TestCase

# Create your tests here.
```

## investments/urls.py

```python
from django.urls import path
from . import views

app_name = "investments"

urlpatterns = [
    path("pledge/<int:listing_id>/", views.pledge_investment_view, name="pledge"),
    path("retract/<int:investment_id>/", views.retract_pledge_view, name="retract"),

]
```

## investments/views.py

```python
from decimal import Decimal, ROUND_HALF_UP

from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.shortcuts import get_object_or_404, redirect
from django.utils import timezone
from django.views.decorators.http import require_POST

from listings.models import Listing, ListingMedia
from listings.services.pricing import get_return_pct_range
from .forms import InvestmentPledgeForm
from .models import Investment
from .services import calculate_expected_return_pence



def _gbp_to_pence(gbp: Decimal) -> int:
    return int((gbp * Decimal("100")).quantize(Decimal("1"), rounding=ROUND_HALF_UP))


@require_POST
@login_required
def pledge_investment_view(request, listing_id: int):
    listing = get_object_or_404(Listing, pk=listing_id, status=Listing.Status.ACTIVE)

    if listing.owner_id == request.user.id:
        messages.error(request, "You cannot invest in your own listing.")
        return redirect("listings:search_listings")

    form = InvestmentPledgeForm(request.POST)
    if not form.is_valid():
        messages.error(request, "Enter a valid amount.")
        return redirect("listings:search_listings")

    amount_gbp: Decimal = form.cleaned_data["amount_gbp"]
    if amount_gbp <= 0:
        messages.error(request, "Enter a valid amount.")
        return redirect("listings:search_listings")

    amount_pence = _gbp_to_pence(amount_gbp)

    try:
        min_pct, max_pct = get_return_pct_range(listing)
    except Exception:
        messages.error(request, "This listing does not have a valid return band configured.")
        return redirect("listings:search_listings")

    mid_pct = (min_pct + max_pct) / Decimal("2")

    with transaction.atomic():
        listing = Listing.objects.select_for_update().get(pk=listing.pk)
        if listing.status != Listing.Status.ACTIVE:
            messages.error(request, "This listing is no longer available.")
            return redirect("listings:search_listings")

        now = timezone.now()
        if listing.active_until and listing.active_until <= now:
            messages.error(request, "This listing has expired.")
            return redirect("listings:search_listings")

        result = calculate_expected_return_pence(
            amount_pence=amount_pence,
            total_return_percent=mid_pct,
        )
        expected_return_pence = result.expected_return_pence
        expected_total_back_pence = result.expected_total_back_pence

        investment = Investment.objects.create(
            investor=request.user,
            listing=listing,
            amount_pence=amount_pence,
            expected_return_pence=expected_return_pence,
            expected_total_back_pence=expected_total_back_pence,
            status=Investment.Status.PLEDGED,
        )

    messages.success(
        request, 
        f"Pledge created. Pledged Amount: £{investment.amount_gbp:,.2f}, Est. Return: £{investment.expected_return_gbp:,.2f}, Est. Total Back: £{investment.expected_total_back_gbp:,.2f}"
    )
    return redirect("users:dashboard")


@require_POST
@login_required
def retract_pledge_view(request, investment_id: int):
    """
    Retract (cancel) a pledge only if:
      - it belongs to the logged-in user
      - it is currently PLEDGED
      - the related listing is still ACTIVE
      - and (if active_until is set) the listing has not expired yet
    """
    investment = get_object_or_404(
        Investment.objects.select_related("listing"),
        pk=investment_id,
        investor=request.user,
    )

    if investment.status != Investment.Status.PLEDGED:
        messages.error(request, "This pledge cannot be retracted.")
        return redirect("users:dashboard")

    listing = investment.listing
    now = timezone.now()

    if listing.status != Listing.Status.ACTIVE:
        messages.error(request, "You can only retract a pledge while the listing is still active.")
        return redirect("users:dashboard")

    if listing.active_until and listing.active_until <= now:
        messages.error(request, "You can only retract a pledge before the listing expires.")
        return redirect("users:dashboard")

    investment.status = Investment.Status.CANCELLED
    investment.save(update_fields=["status"])

    messages.success(request, "Pledge retracted.")
    return redirect("users:dashboard")
```

## investments/__init__.py

```python

```

## listings/admin.py

```python
from django.contrib import admin

# Register your models here.
```

## listings/apps.py

```python
from django.apps import AppConfig


class ListingsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'listings'
```

## listings/forms.py

```python
from unicodedata import name
from django import forms

from .models import Listing


# Keep your explicit duration choices (these are UI choices, not model choices)
LISTING_DURATION_CHOICES = [
    (7, "7 days"),
    (14, "14 days"),
    (30, "30 days"),
    (60, "60 days"),
]

PROJECT_DURATION_CHOICES = [
    (60, "60 days"),
    (120, "120 days"),
    (200, "200 days"),
    (365, "365 days"),
]


class ListingCreateForm(forms.ModelForm):
    """
    - duration_days = listing active duration (marketplace visibility)
    - project_duration_days = project duration (term to completion)
    """

    duration_days = forms.TypedChoiceField(
        choices=LISTING_DURATION_CHOICES,
        coerce=int,
        label="Listing duration",
        required=True,
    )

    project_duration_days = forms.TypedChoiceField(
        choices=PROJECT_DURATION_CHOICES,
        coerce=int,
        label="Project duration",
        required=True,
    )

    class Meta:
        model = Listing
        fields = [
            "project_name",
            "project_duration_days",
            "source_use",
            "target_use",
            "country",
            "county",
            "postcode_prefix",
            "funding_band",
            "return_type",
            "return_band",
            "duration_days",
        ]
        widgets = {
            "source_use": forms.Select(),
            "target_use": forms.Select(),
            "country": forms.Select(),
            "county": forms.Select(),
            "postcode_prefix": forms.Select(),
            "funding_band": forms.Select(),
            "return_type": forms.Select(),
            "return_band": forms.Select(),
        }

    def __init__(self, *args, **kwargs):
        """
        Add a blank placeholder option to every dropdown so the browser
        doesn't auto-select the first option and falsely mark steps complete.
        """
        super().__init__(*args, **kwargs)

        placeholders = {
            "project_duration_days": "Select project duration",
            "source_use": "Select source use",
            "target_use": "Select target use",
            "country": "Select country",
            "county": "Select county",
            "postcode_prefix": "Select postcode prefix",
            "funding_band": "Select funding band",
            "return_type": "Select return type",
            "return_band": "Select return band",
            "duration_days": "Select listing duration",
        }

        for field_name, placeholder in placeholders.items():
            field = self.fields.get(field_name)
            if not field:
                continue

            # Works for TypedChoiceField and ModelChoice / Choice fields
            if hasattr(field, "choices"):
                choices = list(field.choices)
                if not choices or choices[0][0] != "":
                    field.choices = [("", placeholder)] + choices

    def clean_project_name(self):
        name = (self.cleaned_data.get("project_name") or "").strip()
        return name

    def clean_postcode_prefix(self):
        """
        Basic validation for UK postcode outcodes (SW, CF, EH, etc.)
        """
        value = (self.cleaned_data.get("postcode_prefix") or "").strip().upper()
        if value and len(value) < 2:
            raise forms.ValidationError(
                "Please select a valid postcode prefix (e.g. SW, CF, EH)."
            )
        return value

    def clean_duration_days(self):
        value = self.cleaned_data["duration_days"]
        allowed = {7, 14, 30, 60}
        if value not in allowed:
            raise forms.ValidationError("Select a valid listing duration.")
        return value

    def clean_project_duration_days(self):
        value = self.cleaned_data["project_duration_days"]
        allowed = {60, 120, 200, 365}
        if value not in allowed:
            raise forms.ValidationError("Select a valid project duration.")
        return value

    def clean(self):
        """
        Cross-field validation:
        - Project duration should be >= listing duration (generally expected).
        """
        cleaned = super().clean()
        listing_days = cleaned.get("duration_days")
        project_days = cleaned.get("project_duration_days")

        if listing_days is not None and project_days is not None:
            if project_days < listing_days:
                self.add_error(
                    "project_duration_days",
                    "Project duration should be greater than or equal to the listing duration.",
                )
        return cleaned


class MultiFileInput(forms.ClearableFileInput):
    allow_multiple_selected = True


class ListingMediaForm(forms.Form):
    images = forms.FileField(
        required=False,
        widget=MultiFileInput(
            attrs={"multiple": True, "accept": "image/jpeg,image/png,image/webp"}
        ),
        label="Property images",
    )

    documents = forms.FileField(
        required=False,
        widget=MultiFileInput(attrs={"multiple": True, "accept": ".pdf,.doc,.docx"}),
        label="Plans / documents (PDF, DOC, DOCX)",
    )
```

## listings/migrations/0001_initial.py

```python
# Generated by Django 5.2.8 on 2025-12-21 21:23

import django.db.models.deletion
import listings.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Listing',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('project_name', models.CharField(blank=True, default='', help_text='Optional project name shown in dashboards and opportunities (e.g. Old Police Station).', max_length=120)),
                ('source_use', models.CharField(blank=True, choices=[('commercial', 'Commercial'), ('residential', 'Residential'), ('industrial', 'Industrial')], max_length=20, null=True)),
                ('target_use', models.CharField(blank=True, choices=[('commercial', 'Commercial'), ('residential', 'Residential'), ('industrial', 'Industrial')], max_length=20, null=True)),
                ('country', models.CharField(blank=True, choices=[('england', 'England'), ('scotland', 'Scotland'), ('wales', 'Wales')], max_length=20, null=True)),
                ('county', models.CharField(blank=True, max_length=64, null=True)),
                ('postcode_prefix', models.CharField(blank=True, max_length=10, null=True)),
                ('funding_band', models.CharField(blank=True, choices=[('10000_20000', '£10,000 - £20,000'), ('21000_30000', '£21,000 - £30,000'), ('31000_40000', '£31,000 - £40,000'), ('41000_50000', '£41,000 - £50,000'), ('51000_75000', '£51,000 - £75,000'), ('76000_100000', '£76,000 - £100,000'), ('100000_150000', '£100,000 - £150,000'), ('151000_250000', '£151,000 - £250,000')], max_length=20, null=True)),
                ('return_type', models.CharField(blank=True, choices=[('equity_share', 'Equity Share'), ('financial_payback', 'Financial Payback')], max_length=30, null=True)),
                ('return_band', models.CharField(blank=True, choices=[('2_4', '2% - 4%'), ('5_9', '5% - 9%'), ('10_14', '10% - 14%'), ('15_17_5', '15% - 17.5%')], max_length=20, null=True)),
                ('duration_days', models.PositiveIntegerField(blank=True, help_text='How long the listing stays active to secure funding (days).', null=True)),
                ('project_duration_days', models.PositiveIntegerField(blank=True, help_text='How long the underlying project is expected to run (days).', null=True)),
                ('price_per_day_pence', models.PositiveIntegerField(default=199)),
                ('status', models.CharField(choices=[('draft', 'Draft'), ('pending_payment', 'Pending payment'), ('active', 'Active'), ('expired', 'Expired')], default='draft', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('active_from', models.DateTimeField(blank=True, null=True)),
                ('active_until', models.DateTimeField(blank=True, null=True)),
                ('expected_amount_pence', models.PositiveIntegerField(default=0)),
                ('paid_amount_pence', models.PositiveIntegerField(default=0)),
                ('paid_at', models.DateTimeField(blank=True, null=True)),
                ('stripe_checkout_session_id', models.CharField(blank=True, db_index=True, default='', max_length=255)),
                ('stripe_payment_intent_id', models.CharField(blank=True, default='', max_length=255)),
                ('owner', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='listings', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='ListingMedia',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('file', models.FileField(upload_to=listings.models.listing_media_upload_to)),
                ('media_type', models.CharField(choices=[('image', 'Image'), ('document', 'Document')], max_length=20)),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('listing', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='media', to='listings.listing')),
            ],
        ),
    ]
```

## listings/migrations/__init__.py

```python

```

## listings/models.py

```python
from __future__ import annotations

from datetime import timedelta

from django.conf import settings
from django.db import models
from django.utils import timezone


class Listing(models.Model):
    class UseType(models.TextChoices):
        COMMERCIAL = "commercial", "Commercial"
        RESIDENTIAL = "residential", "Residential"
        INDUSTRIAL = "industrial", "Industrial"

    class Country(models.TextChoices):
        ENGLAND = "england", "England"
        SCOTLAND = "scotland", "Scotland"
        WALES = "wales", "Wales"

    class ReturnType(models.TextChoices):
        EQUITY = "equity_share", "Equity Share"
        PAYBACK = "financial_payback", "Financial Payback"

    class FundingBand(models.TextChoices):
        B10_20 = "10000_20000", "£10,000 - £20,000"
        B21_30 = "21000_30000", "£21,000 - £30,000"
        B31_40 = "31000_40000", "£31,000 - £40,000"
        B41_50 = "41000_50000", "£41,000 - £50,000"
        B51_75 = "51000_75000", "£51,000 - £75,000"
        B76_100 = "76000_100000", "£76,000 - £100,000"
        B100_150 = "100000_150000", "£100,000 - £150,000"
        B151_250 = "151000_250000", "£151,000 - £250,000"

    class ReturnBand(models.TextChoices):
        R2_4 = "2_4", "2% - 4%"
        R5_9 = "5_9", "5% - 9%"
        R10_14 = "10_14", "10% - 14%"
        R15_175 = "15_17_5", "15% - 17.5%"

    class Status(models.TextChoices):
        DRAFT = "draft", "Draft"
        PENDING_PAYMENT = "pending_payment", "Pending payment"
        ACTIVE = "active", "Active"
        EXPIRED = "expired", "Expired"

    owner = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="listings",
    )

    project_name = models.CharField(
        max_length=120,
        blank=True,
        default="",
        help_text="Optional project name shown in dashboards and opportunities (e.g. Old Police Station).",
    )

    source_use = models.CharField(
        max_length=20,
        choices=UseType.choices,
        blank=True,
        null=True,
    )
    target_use = models.CharField(
        max_length=20,
        choices=UseType.choices,
        blank=True,
        null=True,
    )

    country = models.CharField(
        max_length=20,
        choices=Country.choices,
        blank=True,
        null=True,
    )
    county = models.CharField(
        max_length=64,
        blank=True,
        null=True,
    )
    postcode_prefix = models.CharField(
        max_length=10,
        blank=True,
        null=True,
    )

    funding_band = models.CharField(
        max_length=20,
        choices=FundingBand.choices,
        blank=True,
        null=True,
    )
    return_type = models.CharField(
        max_length=30,
        choices=ReturnType.choices,
        blank=True,
        null=True,
    )
    return_band = models.CharField(
        max_length=20,
        choices=ReturnBand.choices,
        blank=True,
        null=True,
    )

    duration_days = models.PositiveIntegerField(
        blank=True,
        null=True,
        help_text="How long the listing stays active to secure funding (days).",
    )

    project_duration_days = models.PositiveIntegerField(
        blank=True,
        null=True,
        help_text="How long the underlying project is expected to run (days).",
    )

    price_per_day_pence = models.PositiveIntegerField(default=199)

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.DRAFT,
    )

    created_at = models.DateTimeField(auto_now_add=True)
    active_from = models.DateTimeField(null=True, blank=True)
    active_until = models.DateTimeField(null=True, blank=True)

    expected_amount_pence = models.PositiveIntegerField(default=0)
    paid_amount_pence = models.PositiveIntegerField(default=0)
    paid_at = models.DateTimeField(null=True, blank=True)

    stripe_checkout_session_id = models.CharField(
        max_length=255,
        blank=True,
        default="",
        db_index=True,
    )
    stripe_payment_intent_id = models.CharField(
        max_length=255,
        blank=True,
        default="",
    )

    def listing_active_days(self) -> int:
        """Safe int value for listing active duration."""
        return int(self.duration_days or 0)

    def project_days(self) -> int:
        """Safe int value for project duration."""
        return int(self.project_duration_days or 0)

    def total_price_pence(self) -> int:
        """
        Listing upload fee. For drafts, duration_days may be None; keep this safe.
        """
        if not self.duration_days:
            return 0
        return int(self.duration_days) * int(self.price_per_day_pence)

    def activate(self) -> None:
        """
        Activate the listing. This uses duration_days (listing active duration),
        NOT project_duration_days (project term).
        """
        if not self.duration_days:
            raise ValueError("Cannot activate listing without duration_days.")

        now = timezone.now()
        self.status = self.Status.ACTIVE
        self.active_from = now
        self.active_until = now + timedelta(days=int(self.duration_days))
        self.save(update_fields=["status", "active_from", "active_until"])

    def __str__(self) -> str:
        name = self.project_name.strip() if self.project_name else ""
        label = name or f"Listing {self.pk}"
        return f"{label} ({self.get_status_display()})"


def listing_media_upload_to(instance: "ListingMedia", filename: str) -> str:
    return f"listing_media/listing_{instance.listing_id}/{filename}"


class ListingMedia(models.Model):
    class MediaType(models.TextChoices):
        IMAGE = "image", "Image"
        DOCUMENT = "document", "Document"

    listing = models.ForeignKey(
        Listing,
        on_delete=models.CASCADE,
        related_name="media",
    )

    file = models.FileField(upload_to=listing_media_upload_to)
    media_type = models.CharField(
        max_length=20,
        choices=MediaType.choices,
    )

    uploaded_at = models.DateTimeField(auto_now_add=True)

    def __str__(self) -> str:
        return f"{self.media_type} for listing {self.listing_id}"
```

## listings/services/payments.py

```python
from datetime import timedelta
import logging

import stripe
from django.conf import settings
from django.db import transaction
from django.urls import reverse
from django.utils import timezone

from ..models import Listing

logger = logging.getLogger(__name__)

def reset_payment_state(listing: Listing) -> None:
    listing.status = Listing.Status.DRAFT
    listing.expected_amount_pence = 0
    listing.paid_amount_pence = 0
    listing.paid_at = None
    listing.stripe_checkout_session_id = ""
    listing.stripe_payment_intent_id = ""

def activate_listing_from_paid_session(*, listing: Listing, session: dict) -> bool:
    session_id = session.get("id")
    amount_total = session.get("amount_total")
    payment_intent = session.get("payment_intent")

    # Check if payment is successful
    if session.get("payment_status") != "paid":
        return False

    if not session_id:
        return False

    if listing.status == Listing.Status.ACTIVE:
        return True

    # Ensure the session ID matches
    if listing.stripe_checkout_session_id and session_id != listing.stripe_checkout_session_id:
        return False

    if amount_total is None:
        return False

    # Check if the amount paid matches the expected amount
    if int(amount_total) != int(listing.expected_amount_pence):
        return False

    # Ensure that duration_days is not None before proceeding with activation
    if listing.duration_days is None:
        raise ValueError("Listing duration is required to activate the listing.")
    
    now = timezone.now()
    listing.paid_amount_pence = int(amount_total)
    listing.paid_at = now
    listing.stripe_payment_intent_id = str(payment_intent or "")
    listing.status = Listing.Status.ACTIVE

    # Safely convert duration_days to integer
    duration_days = int(listing.duration_days)
    listing.active_from = now
    listing.active_until = now + timedelta(days=duration_days)

    listing.save(
        update_fields=[
            "paid_amount_pence",
            "paid_at",
            "stripe_payment_intent_id",
            "status",
            "active_from",
            "active_until",
        ]
    )
    return True

def build_stripe_urls(*, listing: Listing) -> tuple[str, str]:
    # Construct the success and cancel URLs for Stripe
    success_url = (
        settings.SITE_URL
        + reverse("listings:payment_success")
        + f"?listing_id={listing.pk}&session_id={{CHECKOUT_SESSION_ID}}"
    )
    cancel_url = settings.SITE_URL + reverse("listings:payment_cancel", kwargs={"pk": listing.pk})
    return success_url, cancel_url

def ensure_stripe_configured() -> None:
    # Ensure Stripe is properly configured
    if not settings.STRIPE_SECRET_KEY:
        raise RuntimeError("Stripe is not configured on the server.")
    stripe.api_key = settings.STRIPE_SECRET_KEY

def try_reuse_existing_checkout_session(*, listing: Listing) -> str | None:
    """
    If a checkout session exists and is still open, return its URL.
    If it is complete, attempt activation and return None.
    """
    if not listing.stripe_checkout_session_id:
        return None

    try:
        existing = stripe.checkout.Session.retrieve(listing.stripe_checkout_session_id)
        existing_status = getattr(existing, "status", None)

        if existing_status == "open" and getattr(existing, "url", None):
            return existing.url

        if existing_status == "complete":
            try:
                paid_session = stripe.checkout.Session.retrieve(listing.stripe_checkout_session_id)
            except stripe.error.StripeError:
                paid_session = None

            if paid_session:
                with transaction.atomic():
                    locked = Listing.objects.select_for_update().get(pk=listing.pk)
                    activate_listing_from_paid_session(listing=locked, session=paid_session)

    except stripe.error.StripeError as e:
        logger.warning(
            "Failed to retrieve checkout session %s for listing %s: %s",
            listing.stripe_checkout_session_id,
            listing.pk,
            str(e),
        )

    return None
```

## listings/services/pricing.py

```python
from decimal import Decimal
from typing import Tuple

from ..models import Listing


def get_return_pct_range(listing: Listing) -> Tuple[Decimal, Decimal]:
    """
    Returns (min_pct, max_pct) as Decimals based on listing.return_band.
    Replace/keep your existing mapping logic here.
    """
    mapping = {
        Listing.ReturnBand.R2_4: (Decimal("2"), Decimal("4")),
        Listing.ReturnBand.R5_9: (Decimal("5"), Decimal("9")),
        Listing.ReturnBand.R10_14: (Decimal("10"), Decimal("14")),
        Listing.ReturnBand.R15_175: (Decimal("15"), Decimal("17.5")),
    }
    if not listing.return_band or listing.return_band not in mapping:
        raise ValueError("Return band is not configured correctly.")
    return mapping[listing.return_band]


def calculate_listing_price_pence(*, funding_band: str, duration_days: int) -> int:
    """
    Calculates upload fee (in pence). Keep your existing logic here.
    """
    if not duration_days or duration_days <= 0:
        raise ValueError("duration_days must be > 0")

    price_per_day_pence = 199
    return int(duration_days) * int(price_per_day_pence)
```

## listings/templates/listings/create_listing.html

```html
{% extends "core/base_users.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Create Listing – Green Square Capital{% endblock %}

{% block content %}
<div class="container-xl py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">

      <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
        <div>
          <h1 class="h2 fw-semibold mb-1 mt-3 text-success">Create Listing</h1>
          <p class="text-muted small mb-0">Build an opportunity draft. You can edit it before going live.</p>
        </div>
        <a href="{% url 'users:dashboard' %}" class="btn btn-outline-success btn-sm rounded-pill px-3">
          ← Back to dashboard
        </a>
      </div>

      <div class="card border border-success shadow-sm rounded-xxl mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span id="js-stepper-1"
                class="badge rounded-pill px-3 py-2 {% if step1_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                1. Project details
              </span>

              <span class="text-muted small">→</span>

              <span id="js-stepper-2"
                class="badge rounded-pill px-3 py-2 {% if step2_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                2. Project type
              </span>

              <span class="text-muted small">→</span>

              <span id="js-stepper-3"
                class="badge rounded-pill px-3 py-2 {% if step3_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                3. Funding & returns
              </span>

              <span class="text-muted small">→</span>

              <span id="js-stepper-4"
                class="badge rounded-pill px-3 py-2 {% if step4_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                4. Location
              </span>

              <span class="text-muted small">→</span>

              <span id="js-stepper-5"
                class="badge rounded-pill px-3 py-2 {% if step5_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                5. Media uploads
              </span>

              <span class="text-muted small">→</span>

              <span id="js-stepper-6"
                class="badge rounded-pill px-3 py-2 {% if step6_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                6. Activate listing
              </span>
            </div>

            <span class="text-muted small">Draft can be saved anytime</span>
          </div>

          <div id="js-stepper-msg" class="mt-2 small {% if can_activate %}text-success{% else %}fw-bold{% endif %}">
            {% if can_activate %}
            Steps 1–5 complete — activation is available.
            {% else %}
            Complete steps 1–5 to enable activation. You can save a draft at any time.
            {% endif %}
          </div>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger rounded-xxl border border-success shadow-sm">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        {% if media_form.non_field_errors %}
        <div class="alert alert-danger rounded-xxl border border-success shadow-sm">
          {{ media_form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-4 align-items-stretch">

          <div class="col-12 col-lg-6 d-flex flex-column h-100">

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Project details</h2>
                    <p class="text-muted small mb-0">Name your project and set the expected completion term.</p>
                  </div>

                  <span id="js-card-1"
                    class="badge rounded-pill px-3 {% if step1_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 1
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-12">
                    <label for="id_project_name" class="form-label small fw-semibold">Project name</label>
                    {{ form.project_name|add_class:"form-control" }}
                    {% if form.project_name.errors %}
                    <div class="text-danger small mt-1">{{ form.project_name.errors }}</div>
                    {% endif %}
                    <div class="form-text">Optional — e.g. “Old Police Station”.</div>
                  </div>

                  <div class="col-12">
                    <label for="id_project_duration_days" class="form-label small fw-semibold">Project duration</label>
                    {{ form.project_duration_days|add_class:"form-select" }}
                    {% if form.project_duration_days.errors %}
                    <div class="text-danger small mt-1">{{ form.project_duration_days.errors }}</div>
                    {% endif %}
                    <div class="form-text">How long the project is expected to take to complete.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Project Type</h2>
                    <p class="text-muted small mb-0">Choose what the asset is moving from and to.</p>
                  </div>

                  <span id="js-card-2"
                    class="badge rounded-pill px-3 {% if step2_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 2
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-6 col-lg-12">
                    <label for="id_source_use" class="form-label small fw-semibold">From</label>
                    {{ form.source_use|add_class:"form-select" }}
                    {% if form.source_use.errors %}
                    <div class="text-danger small mt-1">{{ form.source_use.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_target_use" class="form-label small fw-semibold">To</label>
                    {{ form.target_use|add_class:"form-select" }}
                    {% if form.target_use.errors %}
                    <div class="text-danger small mt-1">{{ form.target_use.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Funding & Returns</h2>
                    <p class="text-muted small mb-0">Set investor expectations and listing duration.</p>
                  </div>

                  <span id="js-card-3"
                    class="badge rounded-pill px-3 {% if step3_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 3
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-6 col-lg-12">
                    <label for="id_funding_band" class="form-label small fw-semibold">Funding amount</label>
                    {{ form.funding_band|add_class:"form-select" }}
                    {% if form.funding_band.errors %}
                    <div class="text-danger small mt-1">{{ form.funding_band.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_return_type" class="form-label small fw-semibold">Return type</label>
                    {{ form.return_type|add_class:"form-select" }}
                    {% if form.return_type.errors %}
                    <div class="text-danger small mt-1">{{ form.return_type.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_return_band" class="form-label small fw-semibold">Potential return</label>
                    {{ form.return_band|add_class:"form-select" }}
                    {% if form.return_band.errors %}
                    <div class="text-danger small mt-1">{{ form.return_band.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_duration_days" class="form-label small fw-semibold">Listing duration</label>
                    {{ form.duration_days|add_class:"form-select" }}
                    {% if form.duration_days.errors %}
                    <div class="text-danger small mt-1">{{ form.duration_days.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 small text-muted">
                  Your listing will remain active for the selected duration once it’s published.
                </div>
              </div>
            </div>

          </div>

          <div class="col-12 col-lg-6 d-flex flex-column h-100">

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Location</h2>
                    <p class="text-muted small mb-0">Narrow down to a postcode prefix for matching investors.</p>
                  </div>

                  <span id="js-card-4"
                    class="badge rounded-pill px-3 {% if step4_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 4
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-4 col-lg-12">
                    <label for="id_country" class="form-label small fw-semibold">Country</label>
                    {{ form.country|add_class:"form-select" }}
                    {% if form.country.errors %}
                    <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4 col-lg-12">
                    <label for="id_county" class="form-label small fw-semibold">County</label>
                    {{ form.county|add_class:"form-select" }}
                    {% if form.county.errors %}
                    <div class="text-danger small mt-1">{{ form.county.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4 col-lg-12">
                    <label for="id_postcode_prefix" class="form-label small fw-semibold">Postcode prefix</label>
                    {{ form.postcode_prefix|add_class:"form-select" }}
                    {% if form.postcode_prefix.errors %}
                    <div class="text-danger small mt-1">{{ form.postcode_prefix.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 rounded-4 bg-light p-3">
                  <div class="d-flex gap-2 align-items-start">
                    <div class="badge bg-white text-dark border rounded-pill px-3">Tip</div>
                    <p class="text-muted small mb-0">
                      Select a country, then a county, then a postcode prefix.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Media uploads</h2>
                    <p class="text-muted small mb-0">Add images and documents to support your opportunity.</p>
                  </div>

                  <span id="js-card-5"
                    class="badge rounded-pill px-3 {% if step5_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 5
                  </span>
                </div>

                <div class="row g-4">
                  <div class="col-12">
                    <div class="p-3 p-md-4 rounded-4 bg-light">
                      <label class="form-label small fw-semibold" for="{{ media_form.images.id_for_label }}">
                        {{ media_form.images.label }}
                      </label>
                      {{ media_form.images|add_class:"form-control" }}
                      {% if media_form.images.errors %}
                      <div class="text-danger small mt-1">{{ media_form.images.errors }}</div>
                      {% endif %}
                      <div class="form-text">You can select multiple images.</div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="p-3 p-md-4 rounded-4 bg-light">
                      <label class="form-label small fw-semibold" for="{{ media_form.documents.id_for_label }}">
                        {{ media_form.documents.label }}
                      </label>
                      {{ media_form.documents|add_class:"form-control" }}
                      {% if media_form.documents.errors %}
                      <div class="text-danger small mt-1">{{ media_form.documents.errors }}</div>
                      {% endif %}
                      <div class="form-text">You can select multiple documents.</div>
                    </div>
                  </div>
                </div>

                {% if not step5_done %}
                <div class="alert alert-warning mt-3 mb-0 rounded-4 border-0">
                  <div class="small">
                    Step 5 isn’t complete yet — upload at least 1 image or document and save.
                  </div>
                </div>
                {% endif %}

              </div>
            </div>

            <div class="card gsc-cta-card border border-success shadow-sm rounded-xxl flex-grow-1">
              <div class="card-body p-4 p-md-5 text-center d-flex flex-column justify-content-center h-100">

                <div class="d-flex justify-content-center mb-3">
                  <span id="js-card-6"
                    class="badge rounded-pill px-3 {% if step6_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %}">
                    Step 6 • Activate listing
                  </span>
                </div>

                <div
                  class="d-flex flex-column flex-md-row gap-2 justify-content-center align-items-stretch align-items-md-center">
                  <button type="submit" name="action" value="save_draft" class="btn btn-outline-success px-4">
                    Save as draft
                  </button>

                  <button id="js-activate-btn" type="submit" name="action" value="activate" class="btn btn-success px-4"
                    {% if not can_activate %}disabled{% endif %}>
                    Activate listing
                  </button>
                </div>

                <p class="text-muted small mt-3 mb-0">
                  You will be able to edit your draft from the dashboard view.
                </p>

                <p id="js-step6-msg"
                  class="small mt-2 mb-0 {% if can_activate %}text-success{% else %}fw-bold{% endif %}">
                  {% if can_activate %}
                  Ready to activate — you’ll be taken to payment.
                  {% else %}
                  Complete Steps 1–5 (and save) to enable activation.
                  {% endif %}
                </p>

              </div>
            </div>

          </div>

        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<div id="js-listing-endpoints" data-counties-url="{% url 'listings:api_counties' %}"
  data-outcodes-url="{% url 'listings:api_outcodes' %}">
</div>

<div id="js-listing-state"
  data-country="{{ posted_country|default:form.country.value|default:'' }}"
  data-county="{{ posted_county|default:form.county.value|default:'' }}"
  data-outcode="{{ posted_outcode|default:form.postcode_prefix.value|default:'' }}">
</div>

<script src="{% static 'js/listing_stepper.js' %}"></script>

{% endblock %}
```

## listings/templates/listings/edit_listing.html

```html
{% extends "core/base_users.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Edit Listing – Green Square Capital{% endblock %}

{% block content %}
<div class="container-xl py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">

      <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
        <div>
          <h1 class="h2 fw-semibold mb-1 mt-3 text-success">Edit Draft Listing</h1>
          <p class="text-muted small mb-0">Update your draft details and manage uploaded files.</p>
        </div>
        <a href="{% url 'users:dashboard' %}" class="btn btn-outline-success btn-sm rounded-pill px-3">
          ← Back to dashboard
        </a>
      </div>

      <div class="card border-0 shadow-sm rounded-xxl mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="d-flex flex-wrap gap-2 align-items-center">

              <span id="js-stepper-1"
                class="badge {% if step1_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2">
                1. Details
              </span>
              <span class="text-muted small">→</span>

              <span id="js-stepper-2"
                class="badge {% if step2_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2">
                2. Project type
              </span>
              <span class="text-muted small">→</span>

              <span id="js-stepper-3"
                class="badge {% if step3_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2">
                3. Funding
              </span>
              <span class="text-muted small">→</span>

              <span id="js-stepper-4"
                class="badge {% if step4_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2">
                4. Location
              </span>
              <span class="text-muted small">→</span>

              <span id="js-stepper-5"
                class="badge {% if step5_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2"
                data-has-existing="{% if step5_done %}1{% else %}0{% endif %}">
                5. Uploads
              </span>
              <span class="text-muted small">→</span>

              <span id="js-stepper-6"
                class="badge {% if step6_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3 py-2">
                6. Activate listing
              </span>
            </div>

            <span class="text-muted small">Save as a draft at any step</span>
          </div>

          <div id="js-stepper-msg" class="mt-2 small {% if can_activate %}text-success{% else %}text-muted{% endif %}">
            {% if can_activate %}
            Steps 1–5 complete — activation is available.
            {% else %}
            Complete steps 1–5 to enable activation. You can save a draft at any time.
            {% endif %}
          </div>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger rounded-xxl border-0 shadow-sm">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        {% if media_form.non_field_errors %}
        <div class="alert alert-danger rounded-xxl border-0 shadow-sm">
          {{ media_form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-4 align-items-start">

          <div class="col-12 col-lg-6">

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Project details</h2>
                    <p class="text-muted small mb-0">Update the name and expected project duration.</p>
                  </div>

                  <span id="js-card-1"
                    class="badge {% if step1_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3">
                    Step 1
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-12">
                    <label for="id_project_name" class="form-label small fw-semibold">Project name</label>
                    {{ form.project_name|add_class:"form-control" }}
                    {% if form.project_name.errors %}
                    <div class="text-danger small mt-1">{{ form.project_name.errors }}</div>
                    {% endif %}
                    <div class="form-text">Optional — e.g. “Old Police Station”.</div>
                  </div>

                  <div class="col-12">
                    <label for="id_project_duration_days" class="form-label small fw-semibold">Project duration</label>
                    {{ form.project_duration_days|add_class:"form-select" }}
                    {% if form.project_duration_days.errors %}
                    <div class="text-danger small mt-1">{{ form.project_duration_days.errors }}</div>
                    {% endif %}
                    <div class="form-text">How long the underlying project is expected to run.</div>
                  </div>
                </div>

              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Project Type</h2>
                    <p class="text-muted small mb-0">Adjust the asset’s transition details.</p>
                  </div>

                  <span id="js-card-2"
                    class="badge {% if step2_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3">
                    Step 2
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-6 col-lg-12">
                    <label for="id_source_use" class="form-label small fw-semibold">From</label>
                    {{ form.source_use|add_class:"form-select" }}
                    {% if form.source_use.errors %}
                    <div class="text-danger small mt-1">{{ form.source_use.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_target_use" class="form-label small fw-semibold">To</label>
                    {{ form.target_use|add_class:"form-select" }}
                    {% if form.target_use.errors %}
                    <div class="text-danger small mt-1">{{ form.target_use.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Funding & Returns</h2>
                    <p class="text-muted small mb-0">Update expected bands and listing duration.</p>
                  </div>

                  <span id="js-card-3"
                    class="badge {% if step3_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3">
                    Step 3
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-6 col-lg-12">
                    <label for="id_funding_band" class="form-label small fw-semibold">Funding amount</label>
                    {{ form.funding_band|add_class:"form-select" }}
                    {% if form.funding_band.errors %}
                    <div class="text-danger small mt-1">{{ form.funding_band.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_return_type" class="form-label small fw-semibold">Return type</label>
                    {{ form.return_type|add_class:"form-select" }}
                    {% if form.return_type.errors %}
                    <div class="text-danger small mt-1">{{ form.return_type.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_return_band" class="form-label small fw-semibold">Potential return</label>
                    {{ form.return_band|add_class:"form-select" }}
                    {% if form.return_band.errors %}
                    <div class="text-danger small mt-1">{{ form.return_band.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 col-lg-12">
                    <label for="id_duration_days" class="form-label small fw-semibold">Listing duration</label>
                    {{ form.duration_days|add_class:"form-select" }}
                    {% if form.duration_days.errors %}
                    <div class="text-danger small mt-1">{{ form.duration_days.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 small text-muted">
                  Your listing will remain active for the selected duration once it’s published.
                </div>
              </div>
            </div>

          </div>

          <div class="col-12 col-lg-6">

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Location</h2>
                    <p class="text-muted small mb-0">Keep it accurate for investor discovery.</p>
                  </div>

                  <span id="js-card-4"
                    class="badge {% if step4_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3">
                    Step 4
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-md-4 col-lg-12">
                    <label for="id_country" class="form-label small fw-semibold">Country</label>
                    {% render_field form.country class="form-select" data-selected=listing.country %}
                    {% if form.country.errors %}
                    <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4 col-lg-12">
                    <label for="id_county" class="form-label small fw-semibold">County</label>
                    {% render_field form.county class="form-select" data-selected=listing.county %}
                    {% if form.county.errors %}
                    <div class="text-danger small mt-1">{{ form.county.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4 col-lg-12">
                    <label for="id_postcode_prefix" class="form-label small fw-semibold">Postcode prefix</label>
                    {% render_field form.postcode_prefix class="form-select" data-selected=listing.postcode_prefix %}
                    {% if form.postcode_prefix.errors %}
                    <div class="text-danger small mt-1">{{ form.postcode_prefix.errors }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="mt-3 rounded-4 bg-light p-3">
                  <div class="d-flex gap-2 align-items-start">
                    <div class="badge bg-white text-dark border rounded-pill px-3">Tip</div>
                    <p class="text-muted small mb-0">
                      Select a country, then a county, then a postcode prefix.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
              <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Media uploads</h2>
                    <p class="text-muted small mb-0">Add images and documents to support your opportunity.</p>
                  </div>

                  <span id="js-card-5"
                    class="badge {% if step5_done %}bg-success text-white{% else %}bg-light text-dark border{% endif %} rounded-pill px-3"
                    data-has-existing="{% if step5_done %}1{% else %}0{% endif %}">
                    Step 5
                  </span>
                </div>

                <div class="row g-3">
                  <div class="col-12 col-lg-6">
                    <div class="p-3 p-md-4 rounded-4 bg-light h-100">
                      <label class="form-label small fw-semibold" for="{{ media_form.images.id_for_label }}">
                        {{ media_form.images.label }}
                      </label>
                      {{ media_form.images|add_class:"form-control" }}
                      {% if media_form.images.errors %}
                      <div class="text-danger small mt-1">{{ media_form.images.errors }}</div>
                      {% endif %}
                      <div class="form-text">Multiple allowed. JPG/JPEG, PNG, WEBP. Max 5MB each.</div>
                    </div>
                  </div>

                  <div class="col-12 col-lg-6">
                    <div class="p-3 p-md-4 rounded-4 bg-light h-100">
                      <label class="form-label small fw-semibold" for="{{ media_form.documents.id_for_label }}">
                        {{ media_form.documents.label }}
                      </label>
                      {{ media_form.documents|add_class:"form-control" }}
                      {% if media_form.documents.errors %}
                      <div class="text-danger small mt-1">{{ media_form.documents.errors }}</div>
                      {% endif %}
                      <div class="form-text">Multiple allowed. PDF/DOC/DOCX. Max 10MB each.</div>
                    </div>
                  </div>
                </div>

                {% if not step5_done %}
                <div class="alert alert-warning mt-3 mb-0 rounded-4 border-0">
                  <div class="small">
                    Step 5 isn’t complete yet — upload at least 1 image or document to activate.
                  </div>
                </div>
                {% endif %}
              </div>
            </div>

            <div class="card gsc-form-card border border-success shadow-sm rounded-xxl">
              <div class="card-body p-4 p-md-5">

                <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
                  <div>
                    <h2 class="h5 fw-semibold text-success mb-1">Existing media</h2>
                    <p class="text-muted small mb-0">Review and remove uploaded images and documents.</p>
                  </div>
                  <div class="d-flex gap-2">
                    <span class="badge bg-success text-white border rounded-pill px-3">{{ images|length }} image {{ images|length|pluralize }}</span>
                    <span class="badge bg-success text-white border rounded-pill px-3">{{ documents|length }} doc {{ documents|length|pluralize:"s" }}</span>
                  </div>
                </div>

                <ul class="nav nav-pills gsc-inner-tabs mb-3" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active rounded-pill px-3" id="tab-existing-images" data-bs-toggle="pill"
                      data-bs-target="#pane-existing-images" type="button" role="tab">
                      Images
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill px-3" id="tab-existing-docs" data-bs-toggle="pill"
                      data-bs-target="#pane-existing-docs" type="button" role="tab">
                      Documents
                    </button>
                  </li>
                </ul>

                <div class="tab-content">

                  <div class="tab-pane fade show active" id="pane-existing-images" role="tabpanel"
                    aria-labelledby="tab-existing-images">
                    <div class="existing-images-scroll">
                      <div class="row g-3">
                        {% for img in images %}
                        <div class="col-6 col-md-4">
                          <a class="d-block text-decoration-none" href="{{ img.file.url }}" target="_blank"
                            rel="noopener">
                            <div class="gsc-thumb rounded-4 overflow-hidden bg-light border-subtle mb-2">
                              <img src="{{ img.file.url }}" class="img-fluid" alt="">
                            </div>
                          </a>

                          <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill w-100"
                            formaction="{% url 'listings:listing_media_delete' listing.pk img.pk %}" formmethod="post">
                            Delete
                          </button>
                        </div>
                        {% empty %}
                        <div class="col-12">
                          <div class="rounded-4 bg-light p-3">
                            <p class="text-muted small mb-0">No images uploaded.</p>
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <div class="tab-pane fade" id="pane-existing-docs" role="tabpanel"
                    aria-labelledby="tab-existing-docs">
                    <div class="list-group list-group-flush">
                      {% for doc in documents %}
                      <div class="list-group-item px-0 py-3 d-flex justify-content-between align-items-center">
                        <a class="text-decoration-none min-w-0" href="{{ doc.file.url }}" target="_blank"
                          rel="noopener">
                          <div class="fw-semibold small text-truncate">{{ doc.file.name }}</div>
                          <div class="text-muted small">Document</div>
                        </a>

                        <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3 flex-shrink-0"
                          formaction="{% url 'listings:listing_media_delete' listing.pk doc.pk %}" formmethod="post">
                          Delete
                        </button>
                      </div>
                      {% empty %}
                      <div class="list-group-item px-0 py-3 text-muted small">
                        No documents uploaded.
                      </div>
                      {% endfor %}
                    </div>
                  </div>

                </div>

              </div>
            </div>

          </div>

          <div class="col-12">
            <div class="card gsc-cta-card border border-success shadow-sm rounded-xxl mt-1">
              <div class="card-body p-4 p-md-5">
                <div
                  class="d-flex flex-column flex-md-row align-items-stretch align-items-md-center justify-content-between gap-3">
                  <div class="text-center text-md-start">
                    <div class="h3 fw-bold text-success">Step 6 — Save changes or activate</div>
                    <div class="text-muted fw-bold small">
                      Save updates anytime. Activate will take you to payment.
                    </div>
                  </div>

                  <div class="d-flex flex-column flex-sm-row gap-2">
                    <button type="submit" name="action" value="save_draft"
                      class="btn btn-outline-success rounded-pill px-4">
                      Save changes
                    </button>

                    <button id="js-activate-btn" type="submit" name="action" value="activate"
                      class="btn btn-success rounded-pill px-4" {% if not can_activate %}disabled{% endif %}>
                      Activate listing
                    </button>
                  </div>
                </div>

                <p id="js-step6-msg"
                  class="fw-bold small mt-3 mb-0 text-center {% if can_activate %}text-success{% else %}text-muted{% endif %}">
                  {% if can_activate %}
                  Ready to activate — you’ll be taken to payment.
                  {% else %}
                  Complete Steps 2–5 before activating.
                  {% endif %}
                </p>
              </div>
            </div>
          </div>

        </div>

      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<div id="js-listing-endpoints" data-counties-url="{% url 'listings:api_counties' %}"
  data-outcodes-url="{% url 'listings:api_outcodes' %}">
</div>

<script src="{% static 'js/listing_stepper.js' %}"></script>

{% endblock %}
```

## listings/templates/listings/opportunity_detail.html

```html
{% extends "core/base_users.html" %}
{% load static %}

{% block title %}Opportunity {{ listing.id }} – Green Square Capital{% endblock %}

{% block content %}
<div class="container-xl py-5">

  <div class="card border border-success shadow-sm rounded-xxl mb-4 overflow-hidden">
    <div class="card-body p-4 p-md-5">

      <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
        <div class="min-w-0">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="badge bg-success px-3 py-2 rounded-pill">
              {{ listing.project_name }}
            </span>
          </div>

          <h1 class="h4 fw-semibold text-success mb-1 mt-3 text-truncate">
            {{ listing.source_use|capfirst }} → {{ listing.target_use|capfirst }}
          </h1>

          <div class="d-flex flex-wrap gap-2 mt-2 text-muted small">
            <span>{{ listing.country|capfirst }}</span>
            <span>•</span>
            <span>{{ listing.county }}</span>
            <span>•</span>
            <span>{{ listing.postcode_prefix }}</span>
          </div>

          {% if listing.owner %}
          <div class="text-muted small mt-2">
            Posted by
            <span class="fw-semibold text-body">
              {{ listing.owner.get_full_name|default:listing.owner.first_name|default:listing.owner.email }}
            </span>
          </div>
          {% endif %}
        </div>

        <div class="d-flex flex-column align-items-start align-items-md-end gap-2">
          <span class="badge text-bg-success rounded-pill px-3 py-2">Active</span>
          <a href="{% url 'listings:search_listings' %}" class="btn btn-outline-success rounded-pill px-3">
            ← Back to search
          </a>
        </div>
      </div>

      {# --- TOP METRICS (now includes Project duration + Listing duration) --- #}
      <div class="row g-3 mt-4">
        <div class="col-6 col-lg-2">
          <div class="rounded-4 bg-success text-white border-subtle p-3 h-100">
            <div class="text-white small">Funding</div>
            <div class="fw-semibold">{{ listing.get_funding_band_display }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="rounded-4 bg-success text-white border-subtle p-3 h-100">
            <div class="text-white small">Return Type</div>
            <div class="fw-semibold">{{ listing.get_return_type_display }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="rounded-4 bg-success text-white border-subtle p-3 h-100">
            <div class="text-white small">Potential Return</div>
            <div class="fw-semibold">{{ listing.get_return_band_display }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="rounded-4 bg-success text-white border-subtle p-3 h-100">
            <div class="text-white small">Project duration</div>
            <div class="fw-semibold">
              {% if listing.project_duration_days %}
              {{ listing.project_duration_days }} days
              {% else %}
              —
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-3">
          <div class="rounded-4 bg-success text-white border-subtle p-3 h-100">
            <div class="text-white small">Listing duration</div>
            <div class="fw-semibold">
              {% if listing.duration_days %}
              {{ listing.duration_days }} days
              {% else %}
              —
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {# --- FUNDING PROGRESS (requires view context vars) --- #}
      <div class="mt-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="fw-semibold text-success">Funding progress</div>
          <div class="text-muted small">
            Pledged: <span class="fw-semibold text-body">{{ pledged_gbp }}</span>
            {% if target_gbp %}
            • Target: <span class="fw-semibold text-body">£{{ target_gbp }}</span>
            • Remaining: <span class="fw-semibold text-body">{{ remaining_gbp }}</span>
            {% endif %}
          </div>
        </div>

        <div class="progress rounded-pill mt-2" style="height: 12px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_pct|default:'0' }};"
            aria-valuenow="{{ progress_pct|default:'0' }}" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>

        <div class="text-muted small mt-2">
          {% if target_gbp %}
          {{ progress_pct|default:'0' }}% funded
          {% else %}
          Funding target not available for this listing.
          {% endif %}
        </div>
      </div>

      {% if listing.active_until %}
      <div class="text-muted small mt-3">
        Active until <span class="fw-semibold text-body">{{ listing.active_until|date:"d M Y" }}</span>
      </div>
      {% endif %}

    </div>
  </div>

  <div class="gsc-quad">

    {# --- IMAGES --- #}
    <div class="card border border-success shadow-sm rounded-xxl gsc-card-fill">
      <div class="card-body p-4 p-md-5 d-flex flex-column">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h2 class="h5 fw-semibold text-success mb-1">Images</h2>
            <p class="text-muted small mb-0">Click an image to open it in a new tab.</p>
          </div>
          <span class="badge bg-success text-white border rounded-pill px-3">{{ images|length }}</span>
        </div>

        <div class="row g-3 gsc-scroll-area">
          {% for img in images %}
          <div class="col-6 col-md-4 col-xl-3">
            <a href="{{ img.file.url }}" target="_blank" class="text-decoration-none">
              <div class="gsc-thumb gsc-lift rounded-4 overflow-hidden bg-light border-subtle">
                <img src="{{ img.file.url }}" alt="">
                <div class="gsc-thumb-overlay">
                  <span class="badge bg-white text-dark border rounded-pill px-3">Open</span>
                </div>
              </div>
            </a>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="rounded-4 bg-light border-subtle p-4 text-center">
              <div class="fw-semibold">No images uploaded</div>
              <div class="text-muted small">Images will appear here when available.</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# --- DOCUMENTS --- #}
    <div class="card border border-success shadow-sm rounded-xxl gsc-card-fill" id="documents">
      <div class="card-body p-4 p-md-5 d-flex flex-column">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h2 class="h5 fw-semibold text-success mb-1">Documents</h2>
            <p class="text-muted small mb-0">Open documents in a new tab.</p>
          </div>
          <span class="badge bg-success text-white border rounded-pill px-3">{{ documents|length }}</span>
        </div>

        <div class="list-group list-group-flush gsc-scroll-area">
          {% for doc in documents %}
          <div class="list-group-item px-0 py-3 d-flex justify-content-between align-items-center gap-3">
            <div class="min-w-0 d-flex align-items-center gap-3">
              <div class="gsc-file-icon rounded-4 border-subtle bg-light"></div>
              <div class="min-w-0">
                <div class="fw-semibold small text-truncate">{{ doc.file.name }}</div>
                <div class="text-muted small">Document</div>
              </div>
            </div>
            <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-success rounded-pill px-3">
              Open
            </a>
          </div>
          {% empty %}
          <div class="px-0 py-3">
            <div class="rounded-4 bg-light border-subtle p-4 text-center">
              <div class="fw-semibold">No documents uploaded</div>
              <div class="text-muted small">Documents will appear here when available.</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# --- PLEDGE --- #}
    <div class="card border border-success shadow-sm rounded-xxl gsc-card-fill">
      <div class="card-body p-4 p-md-5 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h2 class="h5 fw-semibold text-success mb-1">Pledge</h2>
            <p class="text-muted small mb-0">Enter an amount to see an estimate.</p>
          </div>
          <span class="badge bg-success text-white border rounded-pill px-3">Invest</span>
        </div>

        <form method="post" action="{% url 'investments:pledge' listing.pk %}" class="mt-3">
          {% csrf_token %}
          <label class="form-label small fw-semibold">Pledge amount</label>
          <div class="input-group">
            <span class="input-group-text bg-light border-subtle">£</span>
            <input type="number" name="amount_gbp" class="form-control js-pledge-amount border-subtle" step="0.01"
              min="1" placeholder="e.g. 1000" required data-listing-id="{{ listing.id }}"
              data-estimate-url="{% url 'listings:estimate_return' listing.pk %}">
            <button type="submit" class="btn btn-success px-4">Pledge</button>
          </div>

          <div class="mt-3 rounded-4 bg-light border-subtle p-3">
            <div class="text-muted small js-return-estimate" data-listing-id="{{ listing.id }}">
              Expected return will be calculated based on this listing’s return and duration.
            </div>
          </div>
        </form>

        <div class="mt-auto pt-3">
          <a href="{% url 'listings:search_listings' %}" class="btn btn-outline-success w-100 rounded-pill">
            ← Back to search
          </a>
        </div>
      </div>
    </div>

    {# --- SUMMARY --- #}
    <div class="card border border-success shadow-sm rounded-xxl gsc-card-fill">
      <div class="card-body p-4 p-md-5 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2 class="h5 fw-semibold text-success mb-1">Summary</h2>
            <p class="text-muted small mb-0">Key details at a glance.</p>
          </div>
          <span class="badge bg-success text-white border rounded-pill px-3">Details</span>
        </div>

        <div class="rounded-4 border border-success p-3 bg-light">
          <div class="d-flex justify-content-between small py-2">
            <span class="fw-semibold">Funding</span>
            <span class="fw-semibold">{{ listing.get_funding_band_display }}</span>
          </div>
          <div class="d-flex justify-content-between small py-2 border-top">
            <span class="fw-semibold">Return</span>
            <span class="fw-semibold">{{ listing.get_return_band_display }}</span>
          </div>
          <div class="d-flex justify-content-between small py-2 border-top">
            <span class="fw-semibold">Project duration</span>
            <span class="fw-semibold">
              {% if listing.project_duration_days %}{{ listing.project_duration_days }} days{% else %}—{% endif %}
            </span>
          </div>
          <div class="d-flex justify-content-between small py-2 border-top">
            <span class="fw-semibold">Listing duration</span>
            <span class="fw-semibold">
              {% if listing.duration_days %}{{ listing.duration_days }} days{% else %}—{% endif %}
            </span>
          </div>
          <div class="d-flex justify-content-between small py-2 border-top">
            <span class="fw-semibold">Pledged</span>
            <span class="fw-semibold">{{ pledged_gbp }}</span>
          </div>
          {% if target_gbp %}
          <div class="d-flex justify-content-between small py-2 border-top">
            <span class="fw-semibold">Remaining</span>
            <span class="fw-semibold">{{ remaining_gbp }}</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script src="{% static 'js/pledge_progress.js' %}"></script>

{% endblock %}
```

## listings/templates/listings/search_listings.html

```html
{% extends "core/base_users.html" %}
{% load static %}

{% block title %}Search Listings – Green Square Capital{% endblock %}

{% block content %}
<div class="container-xl py-5">

  {# --- Header --- #}
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
    <div>
      <span class="badge text-bg-success px-3 py-2 rounded-pill">Green Square Capital</span>
      <h1 class="h4 fw-semibold text-success mb-1 mt-3">Find investment opportunities</h1>
      <p class="text-muted small mb-0">
        Search by project, type, location, funding and returns. Pledge directly from results.
      </p>
    </div>
    <a href="{% url 'users:dashboard' %}" class="btn btn-outline-success btn-sm rounded-pill px-3">
      ← Back to dashboard
    </a>
  </div>

  {# --- Search / Filters --- #}
  <form method="get" class="card gsc-form-card border border-success shadow-sm rounded-xxl mb-4">
    <div class="card-body p-4 p-md-5">

      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <div class="h5 fw-semibold text-success">Search & filters</div>
          <div class="text-muted small">Refine results without leaving the page.</div>
        </div>
        <span class="badge bg-success text-white border rounded-pill px-3">Filters</span>
      </div>

      <div class="row g-3 align-items-end">

        {# Project Name (Free text) #}
        <div class="col-12 col-lg-4">
          <label for="id_project_name" class="form-label small fw-semibold">Project Name</label>
          <input id="id_project_name" type="text" name="project_name" value="{{ project_name }}" class="form-control"
            placeholder="e.g. Riverside Apartments">
        </div>

        {# Listed by (Free text: name/email) #}
        <div class="col-12 col-lg-4">
          <label for="id_listed_by" class="form-label small fw-semibold">Listed by</label>
          <input id="id_listed_by" type="text" name="listed_by" value="{{ listed_by }}" class="form-control"
            placeholder="Name or email">
        </div>

        {# Project type (Dropdowns) - assumes your view provides source_use_choices/target_use_choices #}
        <div class="col-6 col-lg-2">
          <label for="id_source_use" class="form-label small fw-semibold">From (use)</label>
          <select id="id_source_use" name="source_use" class="form-select">
            <option value="">Any</option>
            {% for value,label in source_use_choices %}
            <option value="{{ value }}" {% if source_use == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label for="id_target_use" class="form-label small fw-semibold">To (use)</label>
          <select id="id_target_use" name="target_use" class="form-select">
            <option value="">Any</option>
            {% for value,label in target_use_choices %}
            <option value="{{ value }}" {% if target_use == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        {# Location (Dropdowns) #}
        <div class="col-6 col-lg-2">
          <label for="id_country" class="form-label small fw-semibold">Country</label>
          <select id="id_country" name="country" class="form-select" data-selected="{{ country }}">
            <option value="">Any country</option>
            {% for value,label in country_choices %}
            <option value="{{ value }}" {% if country == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label for="id_county" class="form-label small fw-semibold">County</label>
          <select id="id_county" name="county" class="form-select" data-selected="{{ county }}" disabled>
            <option value="">Any county</option>
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label for="id_postcode_prefix" class="form-label small fw-semibold">Postcode prefix</label>
          <select id="id_postcode_prefix" name="postcode_prefix" class="form-select"
            data-selected="{{ postcode_prefix }}" disabled>
            <option value="">Any prefix</option>
          </select>
        </div>

        {# Funding & returns (Dropdowns) #}
        <div class="col-6 col-lg-2">
          <label for="id_funding_band" class="form-label small fw-semibold">Funding band</label>
          <select id="id_funding_band" name="funding_band" class="form-select">
            <option value="">Any</option>
            {% for value,label in funding_band_choices %}
            <option value="{{ value }}" {% if funding_band == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label for="id_return_type" class="form-label small fw-semibold">Return type</label>
          <select id="id_return_type" name="return_type" class="form-select">
            <option value="">Any</option>
            {% for value,label in return_type_choices %}
            <option value="{{ value }}" {% if return_type == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-lg-2">
          <label for="id_return_band" class="form-label small fw-semibold">Return band</label>
          <select id="id_return_band" name="return_band" class="form-select">
            <option value="">Any</option>
            {% for value,label in return_band_choices %}
            <option value="{{ value }}" {% if return_band == value %}selected{% endif %}>
              {{ label }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-lg-2 d-grid">
          <button class="btn btn-outline-success rounded-pill" type="submit">
            Search
          </button>
        </div>

        <div class="col-12 col-lg-2 d-grid">
          <a class="btn btn-outline-success rounded-pill" href="{% url 'listings:search_listings' %}">
            Clear
          </a>
        </div>

      </div>
    </div>
  </form>

  {# --- Results summary --- #}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    {% if page_obj.object_list %}
    <div class="text-muted small">
      Showing <span class="fw-semibold">{{ page_obj.object_list|length }}</span>
      opportunity{{ page_obj.object_list|length|pluralize }} on this page.
    </div>
    <div class="text-muted small">
      Page <span class="fw-semibold">{{ page_obj.number }}</span>
      of <span class="fw-semibold">{{ page_obj.paginator.num_pages }}</span>
    </div>
    {% endif %}
  </div>

  {% if page_obj.object_list %}
  <div class="row g-4">
    {% for listing in page_obj.object_list %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card gsc-form-card border border-success shadow-sm rounded-xxl h-100">
        <div class="card-body p-4 d-flex flex-column">

          <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
            <div class="min-w-0">
              <h2 class="h5 fw-semibold mb-1 text-success text-truncate">
                {{ listing.source_use|capfirst }} → {{ listing.target_use|capfirst }}
              </h2>
              <p class="text-muted small mb-0 text-truncate">
                {{ listing.country|capfirst }} • {{ listing.county }} • {{ listing.postcode_prefix }}
              </p>

              {# Project name (if you want it visible on cards) #}
              {% if listing.project_name %}
              <p class="text-muted small mb-0 text-truncate">
                {{ listing.project_name }}
              </p>
              {% endif %}

              {% if listing.owner %}
              <p class="text-muted small mb-0">
                Listed by
                {% if listing.owner.get_full_name %}
                {{ listing.owner.get_full_name }}
                {% elif listing.owner.first_name %}
                {{ listing.owner.first_name }}
                {% else %}
                {{ listing.owner.email }}
                {% endif %}
              </p>
              {% endif %}
            </div>
            <span class="badge text-bg-success rounded-pill px-3">Active</span>
          </div>

          <div class="rounded-4 bg-light p-3 my-3">
            <div class="d-flex justify-content-between small">
              <span class="fw-semibold">Funding</span>
              <span class="fw-semibold">{{ listing.get_funding_band_display }}</span>
            </div>
            <div class="d-flex justify-content-between small mt-2">
              <span class="fw-semibold">Return Type</span>
              <span class="fw-semibold">{{ listing.get_return_type_display }}</span>
            </div>
            <div class="d-flex justify-content-between small mt-2">
              <span class="fw-semibold">Potential Return</span>
              <span class="fw-semibold">{{ listing.get_return_band_display }}</span>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center small text-muted mb-3">
            <span>{{ listing.media.count }} file{{ listing.media.count|pluralize }} uploaded</span>
            <span class="badge bg-light text-dark border rounded-pill px-3">
              {{ listing.duration_days }} days
            </span>
          </div>

          <a class="btn btn-sm btn-outline-success rounded-pill px-3 mt-auto"
            href="{% url 'listings:opportunity_detail' listing.pk %}">
            View listing
          </a>

          <form method="post" action="{% url 'investments:pledge' listing.pk %}" class="mt-3">
            {% csrf_token %}

            <label class="form-label small fw-semibold mb-2">Pledge amount</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text">£</span>
              <input type="number" name="amount_gbp" class="form-control js-pledge-amount" step="0.01" min="1"
                placeholder="Amount" required data-listing-id="{{ listing.id }}"
                data-estimate-url="{% url 'listings:estimate_return' listing.pk %}">
              <button type="submit" class="btn btn-success">
                Pledge
              </button>
            </div>

            <div class="mt-2 text-muted small js-return-estimate" data-listing-id="{{ listing.id }}">
              Expected return will be calculated based on this listing’s return and duration.
            </div>
          </form>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item mx-2">
        <a class="page-link rounded-pill px-3"
          href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
          Previous
        </a>
      </li>
      {% else %}
      <li class="page-item mx-2 disabled">
        <span class="page-link rounded-pill px-3">Previous</span>
      </li>
      {% endif %}

      <li class="page-item mx-2 disabled">
        <span class="page-link rounded-pill px-3">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
      <li class="page-item mx-2">
        <a class="page-link rounded-pill px-3"
          href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
          Next
        </a>
      </li>
      {% else %}
      <li class="page-item mx-2 disabled">
        <span class="page-link rounded-pill px-3">Next</span>
      </li>
      {% endif %}
    </ul>
  </nav>

  {% else %}
  <div class="card gsc-form-card border border-success shadow-sm rounded-xxl">
    <div class="card-body p-4 p-md-5">
      <h2 class="h5 fw-semibold text-success mb-1">No listings found</h2>
      <p class="text-muted small mb-0">
        Try broadening your search or clearing filters.
      </p>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}


{% block extra_js %}
{{ block.super }}

<div id="js-search-endpoints" data-counties-url="{% url 'listings:api_counties' %}"
  data-outcodes-url="{% url 'listings:api_outcodes' %}">
</div>

<script src="{% static 'js/search_filters.js' %}"></script>

{% endblock %}
```

## listings/tests.py

```python
from django.test import TestCase

# Create your tests here.
```

## listings/urls.py

```python
from django.urls import path
from . import views

app_name = "listings"

urlpatterns = [
    path("create-listing/", views.create_listing_view, name="create_listing"),
    path("<int:pk>/", views.listing_detail_view, name="listing_detail"),
    path("<int:pk>/edit/", views.edit_listing_view, name="edit_listing"),
    path("<int:pk>/delete/", views.listing_delete_view, name="listing_delete"),
    path(
        "<int:pk>/media/<int:media_id>/delete/",
        views.listing_media_delete_view,
        name="listing_media_delete",
    ),
    path("search/", views.search_listings_view, name="search_listings"),
    path("opportunities/<int:pk>/", views.opportunity_detail_view, name="opportunity_detail"),
    path(
        "opportunities/<int:pk>/estimate-return/",
        views.estimate_return_view,
        name="estimate_return",
    ),
    path("<int:pk>/activate/", views.activate_listing_view, name="activate_listing"),
    path("<int:pk>/checkout/", views.start_listing_checkout_view, name="listing_checkout"),
    path("payments/success/", views.payment_success_view, name="payment_success"),
    path("payments/cancel/<int:pk>/", views.payment_cancel_view, name="payment_cancel"),
    path("stripe/webhook/", views.stripe_webhook, name="stripe_webhook"),
    path("api/counties/", views.api_counties, name="api_counties"),
    path("api/outcodes/", views.api_outcodes, name="api_outcodes"),
    path("api/stepper/", views.api_listing_stepper_flags, name="api_listing_stepper_flags_create"),
    path("api/stepper/<int:pk>/", views.api_listing_stepper_flags, name="api_listing_stepper_flags_edit"),
]
```

## listings/__init__.py

```python

```

## manage.py

```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'GreenSquareCapital.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
```

## pytest.ini

```text
[pytest]
DJANGO_SETTINGS_MODULE = GreenSquareCapital.settings
python_files = tests.py test_*.py *_tests.py
markers =
        live: tests that hit the live Render deployment
```

## requirements-test.txt

```text
pytest-django==4.10.0
pytest==8.3.4
pytest-playwright==0.6.2
playwright==1.50.0
python-dotenv==1.0.1
requests==2.32.5
coverage==7.13.0
```

## search/admin.py

```python
from django.contrib import admin

# Register your models here.
```

## search/apps.py

```python
from django.apps import AppConfig


class SearchConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'search'
```

## search/migrations/__init__.py

```python

```

## search/models.py

```python
from django.db import models

# Create your models here.
```

## search/tests.py

```python
from django.test import TestCase

# Create your tests here.
```

## search/urls.py

```python
from django.urls import path

app_name = "search"

urlpatterns = [
]
```

## search/views.py

```python
from django.shortcuts import render

# Create your views here.
```

## search/__init__.py

```python

```

## static/admin.py

```python
from django.contrib import admin

# Register your models here.
```

## static/apps.py

```python
from django.apps import AppConfig


class StaticConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'static'
```

## static/assets/stylesheets/authentication.css

```css
/* Authentication styles */

/* Legacy container (keep if still used anywhere) */
.login-register-container {
  max-width: 400px;
  margin: 50px auto;
  padding: 30px;
  background-color: #f7f7f7;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  border: 2px solid var(--gsc-green);
}

@media (max-width: 767.98px) {
  .login-register-container {
    max-width: 90%;
    padding: 20px;
    margin: 30px auto;
  }
}

.border-primary {
  border-color: var(--gsc-green) !important;
  border-width: 2px !important;
}

/* Legacy card title (scoped to legacy container only) */
.login-register-container .card-title {
  font-size: 1.8rem;
  color: var(--gsc-green) !important;
}

/* Tabs */
.nav-pills .nav-link {
  color: var(--gsc-green) !important;
  border-color: var(--gsc-green) !important;
}

.nav-pills .nav-link.active {
  background-color: var(--gsc-green) !important;
  border-color: var(--gsc-green) !important;
  color: #ffffff !important;
}
```

## static/assets/stylesheets/base.css

```css
:root {
  --gsc-green: #2f6f3a;
  --gsc-green-dark: #275f31;
  --gsc-green-ink: rgba(255, 255, 255, 0.92);
  --gsc-green-ink-soft: rgba(255, 255, 255, 0.78);
  --gsc-white: #ffffff;
}

.gsc-bar {
  background: linear-gradient(180deg, var(--gsc-green) 0%, var(--gsc-green-dark) 100%);
  color: var(--gsc-green-ink);
  border-color: #2f6f3a;
  backdrop-filter: saturate(140%) blur(6px);
}

.gsc-nav {
  border-bottom: 1px solid #2f6f3a;
}

.gsc-footer {
  border-top: 1px solid #2f6f3a;
}

.gsc-bar-inner {
  padding-left: 1rem;
  padding-right: 1rem;
}

@media (min-width: 992px) {
  .gsc-bar-inner {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }
}

@media (min-width: 1400px) {
  .gsc-bar-inner {
    padding-left: 2rem;
    padding-right: 2rem;
  }
}

/* Brand */
.gsc-brand-badge {
  background-color: #1f7a35;
  color: #fff;
  border-radius: 999px;
  padding: 0.45rem 0.8rem;
}

.gsc-brand-title {
  letter-spacing: -0.02em;
  line-height: 1.1;
}

.gsc-brand-subtitle {
  font-size: 0.825rem;
  color: var(--gsc-green-ink-soft);
  margin-top: 0.15rem;
}

/* Links/chips */
.gsc-nav-link {
  color: var(--gsc-green-ink);
  text-decoration: none;
}

.gsc-nav-link:hover {
  color: #fff;
  text-decoration: none;
}

.gsc-nav-chip {
  padding: 0.5rem 1rem;
  border-radius: 999px;
  font-weight: 600;
  color: var(--gsc-green-ink);
  text-decoration: none;
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.22);
  transition: transform .08s ease, background-color .12s ease, border-color .12s ease;
}

.gsc-nav-chip:hover {
  background: rgba(255,255,255,0.16);
  border-color: rgba(255,255,255,0.30);
  transform: translateY(-1px);
  color: #fff;
}

.gsc-alert {
  border: 0;
  border-radius: 1.25rem;
  box-shadow: 0 10px 28px rgba(15, 23, 42, 0.10);
}

/* Footer links */
.gsc-footer-link {
  color: var(--gsc-green-ink);
  text-decoration: none;
}

.gsc-footer-link:hover {
  color: #fff;
  text-decoration: underline;
}

.gsc-footer-bottom {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255,255,255,0.14);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  font-size: 0.875rem;
}

@media (min-width: 768px) {
  .gsc-footer-bottom {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
}

section.gsc-stats-strip {
  background-color: transparent !important;
  background-image:
    radial-gradient(1200px 600px at 20% 50%, rgba(25, 135, 84, 0.45), transparent 60%),
    radial-gradient(900px 500px at 80% 50%, rgba(15, 111, 69, 0.45), transparent 60%),
    linear-gradient(135deg, #198754 0%, #0f6f45 100%) !important;
  background-repeat: no-repeat;
  background-size: cover;
  overflow: hidden;
}
```

## static/assets/stylesheets/components.css

```css
/* Shared components + utilities */

/* Utilities */
.rounded-xxl {
  border-radius: 1.25rem !important;
}

.min-w-0 {
  min-width: 0;
}

.border-subtle {
  border: 1px solid rgba(15, 23, 42, 0.08) !important;
}

/* Form cards */
.gsc-form-card {
  position: relative;
  overflow: hidden;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.gsc-form-card::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 6px;
  background: linear-gradient(180deg, #198754 0%, #0f6f45 100%);
  opacity: 0.9;
}

.gsc-cta-card {
  background:
    radial-gradient(900px 500px at 20% 20%, rgba(25, 135, 84, 0.18), transparent 55%),
    linear-gradient(180deg, rgba(25, 135, 84, 0.08), rgba(25, 135, 84, 0.03));
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.gsc-form-card:hover,
.gsc-cta-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0.75rem 1.5rem rgba(15, 23, 42, 0.10);
}

/* Forms */
.form-label {
  color: #0f5132;
  letter-spacing: 0.01em;
}

/* Thumbnail grid */
.gsc-thumb {
  aspect-ratio: 4 / 3;
  position: relative;
  display: grid;
  place-items: center;
}

.gsc-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Listing edit: existing images scroll */
.existing-images-scroll {
  overflow: auto;
  max-height: 440px;
}

/* Listing edit: inner tabs */
.gsc-inner-tabs .nav-link {
  border: 1px solid rgba(15, 23, 42, 0.12);
  background: #fff;
  color: #0f172a;
}

.gsc-inner-tabs .nav-link.active {
  background: rgba(25, 135, 84, 0.12);
  border-color: rgba(25, 135, 84, 0.35);
  color: #198754;
  font-weight: 600;
}

/* Opportunity detail helpers */
.gsc-quad {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: 1fr;
}

@media (min-width: 992px) {
  .gsc-quad {
    grid-template-columns: 1fr 1fr;
    grid-auto-rows: 1fr;
  }
}

.gsc-card-fill {
  height: 100%;
}

.gsc-scroll-area {
  overflow: auto;
}

.gsc-thumb-overlay {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(0, 0, 0, 0.25);
  opacity: 0;
  transition: 0.15s;
}

.gsc-lift:hover .gsc-thumb-overlay {
  opacity: 1;
}

.gsc-file-icon {
  width: 40px;
  height: 40px;
  border-radius: 1rem;
  background: #f8f9fa;
  border: 1px solid rgba(15, 23, 42, 0.1);
}

.progress {
  background: rgba(15, 23, 42, 0.08);
}

.page-link.rounded-pill.px-3 {
  border: 1px solid #198754; 
  color: #198754;            
  background-color: transparent; 
  padding: 0.375rem 1.25rem; 
  border-radius: 50rem;     
  transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
}

.page-link.rounded-pill.px-3:hover {
  background-color: #198754; 
  color: white;              
}
```

## static/assets/stylesheets/dashboard.css

```css
/* Horizontal scrolling rows for dashboard cards */
.dashboard-scroll {
  overflow-x: auto;
  overflow-y: hidden;
  padding-bottom: 0.5rem;
  -webkit-overflow-scrolling: touch;
  cursor: grab;
  scroll-snap-type: x mandatory;
}

/* Cards should never shrink */
.dashboard-card {
  flex: 0 0 auto;
  scroll-snap-align: start;
}

/* Width rules that currently win in your dashboard */
.dashboard-scroll .card.dashboard-card {
  width: 340px;
}

@media (min-width: 768px) {
  .dashboard-scroll .card.dashboard-card {
    width: 380px;
  }
}

/* Optional: nicer scrollbar on WebKit browsers */
.dashboard-scroll::-webkit-scrollbar {
  height: 6px;
}

.dashboard-scroll::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.dashboard-scroll::-webkit-scrollbar-thumb {
  background: var(--gsc-green);
  border-radius: 3px;
}

.dashboard-scroll.is-dragging {
  cursor: grabbing;
  user-select: none;
}

.dashboard-scroll.is-dragging * {
  user-select: none;
}
```

## static/assets/stylesheets/homepage.css

```css
:root{
  --gsc-radius: 1.25rem;
  --gsc-radius-sm: .9rem;
  --gsc-shadow: 0 .75rem 2rem rgba(0,0,0,.08);
  --gsc-shadow-sm: 0 .35rem 1rem rgba(0,0,0,.08);
}

body {
  background-color: #f7f8fa;
}

.gsc-page-header {
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(25,135,84,.20), transparent 60%),
    linear-gradient(135deg, #0b2e1e 0%, #0f5132 45%, #064024 100%);
  color: #fff;
  border-radius: calc(var(--gsc-radius) + .25rem);
}

.gsc-hero-bg {
  background: url('/static/images/gsc_homepage_greyscale_green_overlay.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.gsc-hero{
  background:
    radial-gradient(1200px 600px at 20% 20%, rgba(25,135,84,0.35), transparent 60%),
    radial-gradient(900px 500px at 80% 30%, rgba(0,0,0,0.35), transparent 60%),
    linear-gradient(135deg, #0b2b1f 0%, #0f3b2a 40%, #0b2b1f 100%);
}

.gsc-hero-divider{
  height: 36px;
  background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, #0f6f45 100%);
}

.gsc-glass{
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 1.25rem;
}

.homepage-card {
  border: 1px solid #198754;
  background-color: #ffffff;
  transition:
    transform 0.3s ease,
    box-shadow 0.3s ease,
    border-color 0.3s ease;
}

.homepage-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
  border-color: #198754;
}

.homepage-card-final-cta {
  border: 1px solid #0f6f45;
  background-color: #0f6f45;
  transition:
    transform 0.3s ease,
    box-shadow 0.3s ease,
    border-color 0.3s ease;
}

.homepage-card-final-cta:hover {
  transform: translateY(-8px);
  box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
  border-color: #0f6f45;
}



.gsc-card {
  border: 0;
  border-radius: var(--gsc-radius);
  box-shadow: var(--gsc-shadow-sm);
  transition: transform .2s ease, box-shadow .2s ease;
}

.gsc-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--gsc-shadow);
}

.gsc-section {
  padding: 3rem 0;
}

.gsc-soft {
  background: rgba(255,255,255,.8);
  backdrop-filter: blur(8px);
}

.form-control, .form-select {
  border-radius: var(--gsc-radius-sm);
  padding: .75rem 1rem;
}

.btn {
  border-radius: var(--gsc-radius-sm);
}

.btn-lg {
  padding: .85rem 1.2rem;
}

.btn-outline-light:hover {
    color: #0b4a0d;
}

.badge {
  border-radius: 999px;
}

.gsc-project-card{
  border-radius: 1.75rem;
  color: white;
  position: relative;
  overflow: hidden;
  background-image:
    linear-gradient(0deg, rgba(2, 51, 13, 0.8), rgba(1, 51, 8, 0.8)),
    var(--bg-image);
  background-size: cover;
  background-position: center;
  min-height: 260px;
  transform: translateY(0);
  transition: transform .2s ease, box-shadow .2s ease;
}

.gsc-project-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 1rem 2.5rem rgba(0, 0, 0, 0.15);
}

.gsc-project-content {
  position: relative;
  z-index: 1;
  color: #fff;
}

.gsc-project-content > .gsc-project-panel {
  background: rgba(255,255,255,.12);
  backdrop-filter: blur(6px);
  border-radius: 1rem;
  padding: .9rem;
  border: 1px solid rgba(255,255,255,.18);
}

.gsc-icon-bubble {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;
  color: #198754;
  font-weight: 700;
  border: 2px solid #198754;
}

.gsc-cta-band{
  border-radius: 1.25rem;
  padding: 1.25rem;
  background: #0f6f45;
}
```

## static/js/click_hold_drag_scroll.js

```javascript
document.addEventListener("DOMContentLoaded", () => {
  const scrollers = document.querySelectorAll(".dashboard-scroll");

  scrollers.forEach((el) => {
    let isDown = false;
    let startX = 0;
    let startScrollLeft = 0;
    let hasDragged = false;

    const DRAG_THRESHOLD = 6;

    el.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      isDown = true;
      hasDragged = false;

      startX = e.pageX;
      startScrollLeft = el.scrollLeft;
    });

    el.addEventListener("mousemove", (e) => {
      if (!isDown) return;

      const walk = e.pageX - startX;

      if (Math.abs(walk) > DRAG_THRESHOLD) {
        hasDragged = true;
        el.classList.add("is-dragging");
        e.preventDefault();
        el.scrollLeft = startScrollLeft - walk;
      }
    });

    const endDrag = () => {
      isDown = false;
      el.classList.remove("is-dragging");
    };

    window.addEventListener("mouseup", endDrag);
    el.addEventListener("mouseleave", endDrag);

    el.addEventListener(
      "click",
      (e) => {
        if (hasDragged) {
          e.preventDefault();
          e.stopPropagation();
          hasDragged = false;
        }
      },
      true 
    );
  });
});
```

## static/js/listing_stepper.js

```javascript
document.addEventListener("DOMContentLoaded", function () {
  (function () {
    const countryEl = document.getElementById("id_country");
    const countyEl = document.getElementById("id_county");
    const outcodeEl = document.getElementById("id_postcode_prefix");

    const endpointsEl = document.getElementById("js-listing-endpoints");
    const COUNTIES_URL = endpointsEl?.dataset?.countiesUrl || "";
    const OUTCODES_URL = endpointsEl?.dataset?.outcodesUrl || "";

    const stateEl = document.getElementById("js-listing-state");
    const savedCountry = (stateEl?.dataset?.country || "").trim();
    const savedCounty = (stateEl?.dataset?.county || "").trim();
    const savedOutcode = (stateEl?.dataset?.outcode || "").trim();

    const initialCountry = String(countryEl?.value || countryEl?.dataset?.selected || savedCountry || "").trim();
    const initialCounty = String(countyEl?.value || countyEl?.dataset?.selected || savedCounty || "").trim();
    const initialOutcode = String(outcodeEl?.value || outcodeEl?.dataset?.selected || savedOutcode || "").trim();

    function setOptions(selectEl, items, placeholder, selectedValue = "") {
      if (!selectEl) return;
      selectEl.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);

      (items || []).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        if (selectedValue && v === selectedValue) opt.selected = true;
        selectEl.appendChild(opt);
      });

      // Extra safety: force value after options exist
      if (selectedValue) selectEl.value = selectedValue;
    }

    async function loadOutcodes(selectedOutcode = "", countyOverride = "") {
      const county = (countyOverride || countyEl?.value || "").trim();

      setOptions(outcodeEl, [], "Select postcode prefix");
      window.gscEditListingSync?.();

      if (!county || !OUTCODES_URL) return;

      const res = await fetch(OUTCODES_URL + "?county=" + encodeURIComponent(county));
      if (!res.ok) return;

      const data = await res.json();
      setOptions(outcodeEl, data.outcodes || [], "Select postcode prefix", selectedOutcode);

      window.gscEditListingSync?.();
    }

    async function loadCounties(selectedCounty = "") {
      const country = (countryEl?.value || "").trim();

      setOptions(countyEl, [], "Select county");
      setOptions(outcodeEl, [], "Select postcode prefix");
      window.gscEditListingSync?.();

      if (!country || !COUNTIES_URL) return;

      const res = await fetch(COUNTIES_URL + "?country=" + encodeURIComponent(country));
      if (!res.ok) return;

      const data = await res.json();
      setOptions(countyEl, data.counties || [], "Select county", selectedCounty);

      window.gscEditListingSync?.();

      const countyNow = (selectedCounty || countyEl?.value || "").trim();
      if (countyNow) {
        countyEl.value = countyNow;
        await loadOutcodes(initialOutcode, countyNow);
        window.gscEditListingSync?.();
      }
    }

    countryEl?.addEventListener("change", () => loadCounties(""));
    countyEl?.addEventListener("change", () => loadOutcodes("", (countyEl?.value || "").trim()));

    if (initialCountry) {
      countryEl.value = initialCountry;
      loadCounties(initialCounty);
    } else {
      setOptions(countyEl, [], "Select county");
      setOptions(outcodeEl, [], "Select postcode prefix");
    }
  })();

  (function () {
    const stepper = {
      s1: document.getElementById("js-stepper-1"),
      s2: document.getElementById("js-stepper-2"),
      s3: document.getElementById("js-stepper-3"),
      s4: document.getElementById("js-stepper-4"),
      s5: document.getElementById("js-stepper-5"),
      s6: document.getElementById("js-stepper-6"),
      msg: document.getElementById("js-stepper-msg"),
    };

    const cards = {
      c1: document.getElementById("js-card-1"),
      c2: document.getElementById("js-card-2"),
      c3: document.getElementById("js-card-3"),
      c4: document.getElementById("js-card-4"),
      c5: document.getElementById("js-card-5"),
      c6: document.getElementById("js-card-6"),
      msg6: document.getElementById("js-step6-msg"),
    };

    const activateBtn = document.getElementById("js-activate-btn");

    const required = {
      step1: ["#id_project_duration_days"],
      step2: ["#id_source_use", "#id_target_use"],
      step3: ["#id_funding_band", "#id_return_type", "#id_return_band", "#id_duration_days"],
      step4: ["#id_country", "#id_county", "#id_postcode_prefix"],
    };

    const imgInput = document.getElementById("id_images");
    const docInput = document.getElementById("id_documents");

    function hasValue(sel) {
      const el = document.querySelector(sel);
      if (!el) return false;
      return String(el.value || "").trim() !== "";
    }

    function stepOk(selectors) {
      return (selectors || []).every(hasValue);
    }

    function mediaSelected() {
      const imgCount = imgInput?.files?.length || 0;
      const docCount = docInput?.files?.length || 0;
      return imgCount + docCount > 0;
    }

    function setPill(el, ok) {
      if (!el) return;
      el.classList.remove("bg-success", "text-white", "bg-light", "text-dark", "border");
      if (ok) el.classList.add("bg-success", "text-white");
      else el.classList.add("bg-light", "text-dark", "border");
    }

    function sync() {
      const ok1 = stepOk(required.step1);
      const ok2 = stepOk(required.step2);
      const ok3 = stepOk(required.step3);
      const ok4 = stepOk(required.step4);
      const ok5 = mediaSelected();
      const okAll = ok1 && ok2 && ok3 && ok4 && ok5;

      setPill(stepper.s1, ok1); setPill(cards.c1, ok1);
      setPill(stepper.s2, ok2); setPill(cards.c2, ok2);
      setPill(stepper.s3, ok3); setPill(cards.c3, ok3);
      setPill(stepper.s4, ok4); setPill(cards.c4, ok4);
      setPill(stepper.s5, ok5); setPill(cards.c5, ok5);
      setPill(stepper.s6, okAll); setPill(cards.c6, okAll);

      if (stepper.msg) {
        stepper.msg.classList.remove("text-success", "text-muted");
        if (okAll) {
          stepper.msg.textContent = "Steps 1–5 complete — activation is available.";
          stepper.msg.classList.add("text-success");
        } else {
          stepper.msg.textContent = "Complete steps 1–5 to enable activation. You can save a draft at any time.";
          stepper.msg.classList.add("text-muted");
        }
      }

      if (cards.msg6) {
        cards.msg6.classList.remove("text-success", "text-muted");
        if (okAll) {
          cards.msg6.textContent = "Ready to activate — you’ll be taken to payment.";
          cards.msg6.classList.add("text-success");
        } else if (!ok5) {
          cards.msg6.textContent = "Upload at least one image or document to complete Step 5.";
          cards.msg6.classList.add("text-muted");
        } else {
          cards.msg6.textContent = "Complete Steps 1–5 to enable activation.";
          cards.msg6.classList.add("text-muted");
        }
      }

      if (activateBtn) {
        activateBtn.disabled = !okAll;
      }
    }

    window.gscEditListingSync = sync;

    const watch = [
      ...required.step1, ...required.step2, ...required.step3, ...required.step4,
    ];

    watch.forEach((sel) => {
      const el = document.querySelector(sel);
      el?.addEventListener("change", sync);
      el?.addEventListener("input", sync);
    });

    imgInput?.addEventListener("change", sync);
    docInput?.addEventListener("change", sync);

    sync();
  })();
});
```

## static/js/login_register_toggle.js

```javascript
(function () {
  // Login password toggle
  const loginPw = document.getElementById("id_password_login");
  const loginBtn = document.getElementById("toggleLoginPassword");
  if (loginPw && loginBtn) {
    loginBtn.addEventListener("click", function () {
      const isPw = loginPw.getAttribute("type") === "password";
      loginPw.setAttribute("type", isPw ? "text" : "password");
      loginBtn.textContent = isPw ? "Hide" : "Show";
    });
  }

  // Register password toggles (both)
  const regPw1 = document.getElementById("id_password_register_1");
  const regPw2 = document.getElementById("id_password_register_2");
  const regBtn = document.getElementById("toggleRegisterPasswords");
  if (regPw1 && regPw2 && regBtn) {
    regBtn.addEventListener("click", function () {
      const isPw = regPw1.getAttribute("type") === "password";
      regPw1.setAttribute("type", isPw ? "text" : "password");
      regPw2.setAttribute("type", isPw ? "text" : "password");
      regBtn.textContent = isPw ? "Hide passwords" : "Show passwords";
    });
  }
})();
```

## static/js/pledge_progress.js

```javascript
(function () {
  const input = document.querySelector(".js-pledge-amount");
  if (!input) return;

  function setEstimate(id, text) {
    const el = document.querySelector(`.js-return-estimate[data-listing-id="${id}"]`);
    if (el) el.textContent = text;
  }

  let timer = null;
  input.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(async () => {
      const val = input.value.trim();
      if (!val) return;
      const res = await fetch(input.dataset.estimateUrl + "?amount=" + val);
      const data = await res.json();
      if (data.ok) {
        setEstimate(input.dataset.listingId,
          `Estimated return: £${data.total_min}–£${data.total_max}`);
      }
    }, 300);
  });
})();
```

## static/js/search_filters.js

```javascript
(function () {
  document.addEventListener("DOMContentLoaded", function () {
    const endpointsEl = document.getElementById("js-search-endpoints");
    if (!endpointsEl) return;

    const countiesUrl = endpointsEl.dataset.countiesUrl;
    const outcodesUrl = endpointsEl.dataset.outcodesUrl;

    if (!countiesUrl || !outcodesUrl) return;

    const countryEl = document.getElementById("id_country");
    const countyEl = document.getElementById("id_county");
    const outcodeEl = document.getElementById("id_postcode_prefix");

    if (!countryEl || !countyEl || !outcodeEl) return;

    function resetSelect(el, placeholder) {
      el.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholder;
      el.appendChild(opt);
    }

    async function loadCounties(countryValue, selectedCounty) {
      resetSelect(countyEl, "Any county");
      resetSelect(outcodeEl, "Any prefix");
      countyEl.disabled = true;
      outcodeEl.disabled = true;

      if (!countryValue) return;

      const url =
        countiesUrl +
        "?country=" +
        encodeURIComponent(countryValue.toLowerCase());

      const res = await fetch(url);
      const data = await res.json();

      (data.counties || []).forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if (selectedCounty && selectedCounty === c) opt.selected = true;
        countyEl.appendChild(opt);
      });

      countyEl.disabled = false;

      if (selectedCounty) {
        await loadOutcodes(selectedCounty, outcodeEl.dataset.selected || "");
      }
    }

    async function loadOutcodes(countyValue, selectedOutcode) {
      resetSelect(outcodeEl, "Any prefix");
      outcodeEl.disabled = true;

      if (!countyValue) return;

      const url =
        outcodesUrl + "?county=" + encodeURIComponent(countyValue);

      const res = await fetch(url);
      const data = await res.json();

      (data.outcodes || []).forEach((o) => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        if (selectedOutcode && selectedOutcode === o) opt.selected = true;
        outcodeEl.appendChild(opt);
      });

      outcodeEl.disabled = false;
    }

    countryEl.addEventListener("change", function () {
      loadCounties(countryEl.value, "");
    });

    countyEl.addEventListener("change", function () {
      loadOutcodes(countyEl.value, "");
    });

    const selectedCountry =
      countryEl.dataset.selected || countryEl.value || "";
    const selectedCounty = countyEl.dataset.selected || "";
    const selectedOutcode = outcodeEl.dataset.selected || "";

    if (selectedCountry) {
      countryEl.value = selectedCountry;
      outcodeEl.dataset.selected = selectedOutcode;
      loadCounties(selectedCountry, selectedCounty);
    } else {
      resetSelect(countyEl, "Any county");
      resetSelect(outcodeEl, "Any prefix");
    }
  });
})();
```

## static/migrations/__init__.py

```python

```

## static/models.py

```python
from django.db import models

# Create your models here.
```

## static/tests.py

```python
from django.test import TestCase

# Create your tests here.
```

## static/views.py

```python
from django.shortcuts import render

# Create your views here.
```

## static/__init__.py

```python

```

## users/admin.py

```python
from django.contrib import admin

# Register your models here.
```

## users/apps.py

```python
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'
```

## users/backends.py

```python
from django.contrib.auth.backends import ModelBackend
from django.contrib.auth import get_user_model

# Get the custom User model
User = get_user_model()


class EmailBackend(ModelBackend):
    """
    Custom authentication backend to allow users
    to log in using their email address
    instead of their username.
    """

    def authenticate(self, request, username=None, password=None, **kwargs):
        """
        Overrides the default authenticate
        method to use email instead of username.
        Parameters:
            - request: the current HttpRequest (can be None).
            - username: will actually be the email address in this context.
            - password: the password provided by the user.
            - **kwargs: any additional keyword arguments (not used here).

        Returns:
            - User instance if authentication is successful.
            - None if authentication fails.
        """
        try:
            # Try to find a user with the provided email (case-insensitive)
            user = User.objects.get(email__iexact=username)
        except User.DoesNotExist:
            # If no user exists with that email,
            # return None (authentication failed)
            return None
        else:
            # Check if the password is correct and
            # the user is allowed to authenticate
            if (
                user.check_password(password)
                    and self.user_can_authenticate(user)):
                return user

        return None
```

## users/migrations/__init__.py

```python

```

## users/models.py

```python
from django.db import models
```

## users/services.py

```python
# users/services.py
from django.utils import timezone
from django.db.models import Q

from .models import Listing


def expire_due_listings() -> int:
    now = timezone.now()

    updated = (
        Listing.objects
        .filter(status=Listing.Status.ACTIVE)
        .filter(active_until__isnull=False, active_until__lte=now)
        .update(status=Listing.Status.EXPIRED)
    )
    return updated
```

## users/templates/users/dashboard.html

```html
{% extends 'core/base_users.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Dashboard – Green Square Capital{% endblock %}

{% block content %}
<div class="container py-5">

    {# --- Page header --- #}
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-4">
        <div>
            <h2 class="h2 fw-semibold text-success mb-1 mt-3">Dashboard</h2>
            <p class="text-muted small mb-0">A quick overview of your investments and listings.</p>
        </div>
    </div>

    {# --- Dashboard summary --- #}
    <div class="row g-3 mb-5">
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-xxl bg-success text-white">
                <div class="card-body p-3">
                    <div class="small text-white">Total pledged</div>
                    <div class="h4 fw-semibold mb-0">{{ total_pledged }}</div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-xxl bg-success text-white">
                <div class="card-body p-3">
                    <div class="small text-white">Active investments</div>
                    <div class="h4 fw-semibold mb-0">{{ active_investments }}</div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-xxl bg-success text-white">
                <div class="card-body p-3">
                    <div class="small text-white">Your Active listings</div>
                    <div class="h4 fw-semibold mb-0">{{ active_listings }}</div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-xxl bg-success text-white">
                <div class="card-body p-3">
                    <div class="small text-white">Draft listings</div>
                    <div class="h4 fw-semibold mb-0">
                        {{ draft_waiting_payment }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- Current Investments --- #}
    <div class="d-flex align-items-end justify-content-between mb-2">
        <div>
            <h3 class="h3 text-success fw-semibold mb-1">Current Investments</h3>
            <p class="text-muted small mb-0">
                A snapshot of your pledged investments. Scroll horizontally to view more.
            </p>
        </div>
    </div>

    <div class="dashboard-scroll mb-5 mt-3">
        <div class="d-flex flex-nowrap gap-3">
            {% if investments %}
            {% for inv in investments %}
            <div class="card dashboard-card flex-shrink-0 border-success shadow-sm rounded-xxl">
                <div class="card-body p-4">

                    <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                        <div class="min-w-0">
                            <h5 class="card-title mb-1 fw-semibold text-success text-truncate">
                                {{ inv.listing.source_use|capfirst }} → {{ inv.listing.target_use|capfirst }}
                            </h5>
                            <p class="text-muted small mb-0 text-truncate">
                                {{ inv.listing.country|capfirst }} • {{ inv.listing.county }} •
                                {{ inv.listing.postcode_prefix }}
                            </p>
                        </div>
                        <span class="badge text-bg-success rounded-pill px-3">Pledged</span>
                    </div>

                    <div class="rounded-4 bg-light p-3 mb-3">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Pledged</span>
                            <span class="fw-semibold">£{{ inv.amount_gbp }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted">Est. return</span>
                            <span class="fw-semibold">£{{ inv.expected_return_gbp }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted">Est. total back</span>
                            <span class="fw-semibold">£{{ inv.expected_total_back_gbp }}</span>
                        </div>
                    </div>

                    <p class="small text-muted mb-3">
                        {{ inv.listing.get_return_type_display }} ({{ inv.listing.get_return_band_display }})<br>
                        Project Duration: {{ inv.listing.project_duration_days }} days<br>
                        Pledged: {{ inv.created_at|date:"d M Y" }}
                    </p>

                    <a href="{% url 'listings:opportunity_detail' inv.listing.pk %}"
                        class="btn btn-sm btn-success w-100">
                        View Listing
                    </a>

                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="card dashboard-card flex-shrink-0 border-success shadow-sm rounded-xxl">
                <div class="card-body p-4 d-flex flex-column justify-content-center">
                    <h5 class="card-title fw-semibold text-success mb-1">No investments yet</h5>
                    <p class="text-muted small mb-0">
                        When you pledge into opportunities, they will appear here.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {# --- Your Listings --- #}
    <div class="d-flex flex-wrap justify-content-between align-items-end gap-3 mb-2">
        <div>
            <h3 class="h3 fw-semibold text-success mb-1">Your Listings (Active and Drafts)</h3>
            <p class="text-muted small mb-0">
                Draft listings are saved but not active until payment is complete.
            </p>
        </div>
        <a href="{% url 'listings:create_listing' %}" class="btn btn-sm btn-success px-3">
            + Create Listing
        </a>
    </div>

    <div class="dashboard-scroll mt-3">
        <div class="d-flex flex-nowrap gap-3">
            {% if listings %}
            {% for listing in listings %}
            <div class="card dashboard-card flex-shrink-0 border-success shadow-sm rounded-xxl">
                <div class="card-body p-4">

                    <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                        <div class="min-w-0">
                            <h5 class="card-title mb-1 fw-semibold text-success text-truncate">
                                {{ listing.source_use|capfirst }} → {{ listing.target_use|capfirst }}
                            </h5>
                            <p class="text-muted small mb-0 text-truncate">
                                {{ listing.country|capfirst }} • {{ listing.county }} • {{ listing.postcode_prefix }}
                            </p>
                        </div>

                        {% if listing.status == "draft" %}
                        <span class="badge text-bg-secondary rounded-pill px-3">Draft</span>
                        {% elif listing.status == "pending_payment" %}
                        <span class="badge text-bg-warning rounded-pill px-3">Pending payment</span>
                        {% elif listing.status == "active" %}
                        <span class="badge text-bg-success rounded-pill px-3">Active</span>
                        {% elif listing.status == "expired" %}
                        <span class="badge text-bg-dark rounded-pill px-3">Expired</span>
                        {% else %}
                        <span class="badge text-bg-light rounded-pill px-3">Unknown</span>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between align-items-center small text-muted mb-3">
                        <span>{{ listing.media.count }} file{{ listing.media.count|pluralize }} uploaded</span>
                        <span class="badge bg-light text-dark border rounded-pill px-3">
                            {{ listing.project_name }}
                        </span>
                    </div>

                    <div class="rounded-4 bg-light border border-success p-3 mb-3">
                        <div class="d-flex justify-content-between small mt-1">
                            <span class="text-muted fw-bold">Funding Required</span>
                            <span class="fw-semibold">{{ listing.get_funding_band_display }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted fw-bold">Return Type</span>
                            <span class="fw-semibold">{{ listing.get_return_type_display }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted fw-bold">Potential Return</span>
                            <span class="fw-semibold">{{ listing.get_return_band_display }}</span>
                        </div>
                        <div class="d-flex justify-content-between small mt-2">
                            <span class="text-muted fw-bold">Project Duration</span>
                            <span class="fw-semibold">{{ listing.duration_days }} days</span>
                        </div>
                    </div>

                    <p class="small text-muted mb-3">
                        {% if listing.active_until %}
                        Ends: {{ listing.active_until|date:"d M Y" }}
                        {% else %}
                        &nbsp;
                        {% endif %}
                    </p>

                    {% if listing.status == "draft" or listing.status == "pending_payment" %}
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{% url 'listings:listing_detail' listing.pk %}"
                            class="btn btn-sm btn-outline-success flex-grow-1">
                            View Draft
                        </a>
                        <a href="{% url 'listings:edit_listing' listing.pk %}"
                            class="btn btn-sm btn-outline-success flex-grow-1">
                            Edit
                        </a>
                    </div>
                    {% else %}
                    <a href="{% url 'listings:listing_detail' listing.pk %}" class="btn btn-sm btn-success w-100">
                        View Listing
                    </a>
                    {% endif %}

                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="card dashboard-card flex-shrink-0 border-success shadow-sm rounded-xxl">
                <div class="card-body p-4 d-flex flex-column justify-content-center">
                    <h5 class="card-title fw-semibold text-success mb-1">No listings yet</h5>
                    <p class="text-muted small mb-3">
                        Create a listing to start offering new opportunities.
                    </p>
                    <a href="{% url 'listings:create_listing' %}" class="btn btn-sm btn-success w-100">
                        Create your first listing
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script src="{% static 'js/click_hold_drag_scroll.js' %}"></script>

{% endblock %}
```

## users/tests.py

```python
from django.test import TestCase

# Create your tests here.
```

## users/urls.py

```python
from django.urls import path
from .views import (
    register_view,
    login_view,
    logout_view,
    dashboard_view,
)

app_name = "users"

urlpatterns = [
    path("login/", login_view, name="login"),
    path("register/", register_view, name="register"),
    path("logout/", logout_view, name="logout"),
    path("dashboard/", dashboard_view, name="dashboard"),
]
```

## users/__init__.py

```python

```

## Statistics

- Total Files: 84
- Total Characters: 289839
- Total Tokens: 0
