{% extends "core/base_users.html" %}
{% block title %}Listing {{ listing.id }} – Green Square Capital{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 class="mb-1">{{ listing.source_use|capfirst }} → {{ listing.target_use|capfirst }}</h2>
      <p class="text-muted mb-0">
        {{ listing.country|capfirst }} • {{ listing.county }} • {{ listing.postcode_prefix }}
      </p>
    </div>

    {% if listing.status == "draft" %}
      <span class="badge text-bg-secondary">Draft</span>
    {% elif listing.status == "active" %}
      <span class="badge text-bg-success">Active</span>
    {% elif listing.status == "expired" %}
      <span class="badge text-bg-dark">Expired</span>
    {% else %}
      <span class="badge text-bg-light">Unknown</span>
    {% endif %}
  </div>

  <div class="d-flex gap-2 flex-wrap mb-3">
    <a href="{% url 'users:dashboard' %}" class="btn btn-sm btn-outline-secondary">
      ← Back to Dashboard
    </a>

    {% if listing.status == "draft" %}
      <a href="{% url 'users:listing_edit' listing.pk %}" class="btn btn-sm btn-primary">
        Edit listing
      </a>

      <a href="{% url 'users:listing_checkout' listing.pk %}" class="btn btn-sm btn-success">
        Continue to payment
      </a>

      <button
        type="button"
        class="btn btn-sm btn-outline-danger"
        data-bs-toggle="modal"
        data-bs-target="#deleteListingModal"
      >
        Delete listing
      </button>
    {% endif %}
  </div>

  {% if listing.status == "draft" %}
    <div class="modal fade" id="deleteListingModal" tabindex="-1" aria-labelledby="deleteListingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="{% url 'users:listing_delete' listing.pk %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="deleteListingModalLabel">Confirm delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <p class="mb-3">
                This will permanently delete this draft listing and its uploaded files. This cannot be undone.
              </p>

              <div class="mb-2">
                <label for="deletePassword" class="form-label">Enter your password to confirm</label>
                <input
                  type="password"
                  class="form-control"
                  id="deletePassword"
                  name="password"
                  required
                  autocomplete="current-password"
                >
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Delete</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-body">
      <p class="mb-2"><strong>Funding:</strong> {{ listing.get_funding_band_display }}</p>
      <p class="mb-2"><strong>Return Type:</strong> {{ listing.get_return_type_display }}</p>
      <p class="mb-2"><strong>Potential Return:</strong> {{ listing.get_return_band_display }}</p>
      <p class="mb-0"><strong>Duration:</strong> {{ listing.duration_days }} days</p>

      {% if listing.active_until %}
        <p class="mb-0 mt-2">
          <strong>Active until:</strong> {{ listing.active_until|date:"d M Y" }}
        </p>
      {% endif %}
    </div>
  </div>

  <h4 class="mb-2">Images</h4>
  <div class="row g-3 mb-4">
    {% for img in images %}
      <div class="col-6 col-md-4 col-lg-3">
        <a href="{{ img.file.url }}" target="_blank" rel="noopener">
          <img src="{{ img.file.url }}" class="img-fluid rounded" alt="">
        </a>
      </div>
    {% empty %}
      <div class="col-12">
        <p class="text-muted mb-0">No images uploaded.</p>
      </div>
    {% endfor %}
  </div>

  <h4 class="mb-2">Documents</h4>
  <ul class="list-group mb-4">
    {% for doc in documents %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ doc.file.name }}</span>
        <a class="btn btn-sm btn-outline-primary" href="{{ doc.file.url }}" target="_blank" rel="noopener">
          Open
        </a>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No documents uploaded.</li>
    {% endfor %}
  </ul>

  <a href="{% url 'users:dashboard' %}" class="btn btn-sm btn-outline-secondary">
    ← Back to Dashboard
  </a>

</div>
{% endblock %}
